---
title: "Assessment Factors"
author: "Scott Coffin"
date: "3/19/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

```{r include=FALSE}
require(readr)
#load aoc_z into dataframe. This file is generated from RDA_Maker.R
aoc_z <- readRDS("Tox Data/aoc_z.Rda")
```

# NOEC & NOEC Distribution

There doesn't seem to be much separation between acute and chronic NOEC/LOEC distributions. If this is the case, is an assessment factor even necessary?

Attempts to be more selective/curate the data further don't really seem to change anything (e.g., filtering for certain size fractions, using quality filters, etc.)

```{r NOEC & LOEC Distributions}

dist <- aoc_z %>% 
  #Remove leachate and additive/chemical transfer experiments
  replace_na(list(chem.exp.typ.nominal = "Particle Only")) %>% 
  dplyr::filter(leachate.only != "Y") %>%
  mutate(chem.exp.typ.nominal_f = factor(case_when(chem.exp.typ.nominal == "Particle Only" ~ "Particle Only",
                                                   chem.exp.typ.nominal == "co.exp" ~ "Chemical Co-Exposure",
                                                   chem.exp.typ.nominal == "sorbed" ~ "Chemical Transfer"))) %>% 
  dplyr::filter(chem.exp.typ.nominal_f == "Particle Only") 
  # filter(tier_zero_tech_f == "Red Criteria Passed")  
  # filter(tier_zero_risk_f == "Red Criteria Passed")

#Dose in mass per volume 
Dist_NOEC_Mass <- dist %>% 
     #Select data where acute and chronic exposure is defined
     filter(acute.chronic_f == c("Acute", "Chronic")) %>%
     #Select NOECs
     filter(effect.metric == "NOEC") %>%
     #Drop rows where there is no dosing data in mass per volume
     drop_na(dose.mg.L.master) %>%  
     select(org_f, effect.metric, acute.chronic_f, dose.mg.L.master) %>%  
     ggplot(aes(x = dose.mg.L.master, fill = acute.chronic_f)) +
     geom_histogram(bins = 50)+
     facet_wrap(~org_f)+
     scale_x_log10() +
     labs(title = "Distribution of Derived NOEC Values", x = "Dose (mg/L)", y = "Count", fill = "Acute vs. Chronic")

plot(Dist_NOEC_Mass)

Dist_LOEC_Mass <- dist %>% 
     #Select data where acute and chronic exposure is defined
     filter(acute.chronic_f == c("Acute", "Chronic")) %>%
     #Select NOECs
     filter(effect.metric == "LOEC") %>%
     #Drop rows where there is no dosing data in mass per volume
     drop_na(dose.mg.L.master) %>% 
     select(org_f, effect.metric, acute.chronic_f, dose.mg.L.master) %>%  
     ggplot(aes(x = dose.mg.L.master, fill = acute.chronic_f)) +
     geom_histogram(bins = 50)+
     facet_wrap(~org_f)+
     scale_x_log10()+
     labs(title = "Distribution of Derived LOEC Values", x = "Dose (mg/L)", y = "Count", fill = "Acute vs. Chronic")

plot(Dist_LOEC_Mass)

#Dose in count per volume
Dist_NOEC_Count <- dist %>% 
     #Select data where acute and chronic exposure is defined
     filter(acute.chronic_f == c("Acute", "Chronic")) %>%
     #Select NOECs
     filter(effect.metric == "NOEC") %>%
     #Drop rows where there is no dosing data in mass per volume
     drop_na(dose.particles.mL.master) %>% 
     select(org_f, effect.metric, acute.chronic_f, dose.particles.mL.master) %>%  
     ggplot(aes(x = dose.particles.mL.master, fill = acute.chronic_f)) +
     geom_histogram(bins = 50)+
     facet_wrap(~org_f)+
     scale_x_log10() +
     labs(title = "Distribution of Derived NOEC Values", x = "Dose (particles/mL)", y = "Count", fill = "Acute vs. Chronic")

plot(Dist_NOEC_Count)

Dist_LOEC_Count <- dist %>% 
     #Select data where acute and chronic exposure is defined
     filter(acute.chronic_f == c("Acute", "Chronic")) %>%
     #Select NOECs
     filter(effect.metric == "LOEC") %>%
     #Drop rows where there is no dosing data in mass per volume
     drop_na(dose.particles.mL.master) %>% 
     select(org_f, effect.metric, acute.chronic_f, dose.particles.mL.master) %>%  
     ggplot(aes(x = dose.particles.mL.master, fill = acute.chronic_f)) +
     geom_histogram(bins = 50)+
     facet_wrap(~org_f)+
     scale_x_log10()+
     labs(title = "Distribution of Derived LOEC Values", x = "Dose (particles/mL)", y = "Count", fill = "Acute vs. Chronic")

plot(Dist_LOEC_Count)

```

```{r How many species within each taxa have both acute and chronic values? }

Species_Taxa_Mass <- aoc_z %>% 
     #Select NOECs
     filter(effect.metric == c("NOEC", "LOEC")) %>%
     #Select data where acute and chronic exposure is defined
     filter(acute.chronic_f == c("Acute", "Chronic")) %>%
     #Drop rows where there is no dosing data in mass per volume
     drop_na(dose.mg.L.master) %>%
     #Group the data by organism group and acute vs chronic data 
     group_by(org_f, species_f, acute.chronic_f, effect.metric) %>%
     #Create a new column for the average NOEC
     summarise() %>% 
     ungroup() %>% 
     group_by(org_f, acute.chronic_f, effect.metric) %>% 
     mutate(species_count = n_distinct(species_f)) %>% 
     ungroup() %>% 
     distinct(org_f, acute.chronic_f, effect.metric, species_count)

Species_Taxa_Mass
```

```{r NOECs}

#Compare differences between acute and chronic values for NOECs in each organism group

Mean_NOEC <- aoc_z %>% 
     #Select NOECs
     filter(effect.metric == "NOEC") %>%
     #Select data where acute and chronic exposure is defined
     filter(acute.chronic_f == c("Acute", "Chronic")) %>%
     #Drop rows where there is no dosing data in mass per volume
     drop_na(dose.mg.L.master) %>%
     #Group the data by organism group and acute vs chronic data 
     group_by(org_f, acute.chronic_f) %>%
     #Create a new column for the average NOEC
     summarise(averageNOEC = mean(dose.mg.L.master)) 
     
acute <- Mean_NOEC %>% 
     #Select only acute data
     filter(acute.chronic_f == "Acute") %>% 
     rename(averageNOEC_acute = averageNOEC)
     
chronic <- Mean_NOEC %>% 
     #Select only chronic data
     filter(acute.chronic_f == "Chronic") %>% 
     rename(averageNOEC_chronic = averageNOEC)

acute_chronic <- left_join(acute, chronic, by = c("org_f" = "org_f")) %>% 
  mutate(change_NOEC = averageNOEC_acute/averageNOEC_chronic)

#Regression between acute and chronic NOECs

plot <- acute_chronic %>% 
  ggplot(aes(x = log10(averageNOEC_chronic), y = log10(averageNOEC_acute))) +
  geom_point() 

plot(plot)
```

```{r LOECs}

#Compare differences between acute and chronic values for NOECs in each organism group

Mean_LOEC <- aoc_z %>% 
     #Select NOECs
     filter(effect.metric == "LOEC") %>%
     #Select data where acute and chronic exposure is defined
     filter(acute.chronic_f == c("Acute", "Chronic")) %>%
     #Drop rows where there is no dosing data in mass per volume
     drop_na(dose.mg.L.master) %>%
     #Group the data by organism group and acute vs chronic data 
     group_by(org_f, acute.chronic_f) %>%
     #Create a new column for the average LOEC
     summarise(averageLOEC = mean(dose.mg.L.master)) 
     
acute <- Mean_LOEC %>% 
     #Select only acute data
     filter(acute.chronic_f == "Acute") %>% 
     rename(averageLOEC_acute = averageLOEC)
     
chronic <- Mean_LOEC %>% 
     #Select only chronic data
     filter(acute.chronic_f == "Chronic") %>% 
     rename(averageLOEC_chronic = averageLOEC)

acute_chronic <- left_join(acute, chronic, by = c("org_f" = "org_f")) %>% 
  mutate(change_LOEC = averageLOEC_acute/averageLOEC_chronic)

#Regression between acute and chronic LOECs

plot <- acute_chronic %>% 
  ggplot(aes(x = log10(averageLOEC_chronic), y = log10(averageLOEC_acute))) +
  geom_point() 

plot(plot)
```


# Acute/Chronic Assessment Factor

```{r}
# collapse data (average) for all combinations of selected variables
grouped <- aoc_z %>% 
   filter(tier_zero_tech_f == "Red Criteria Passed") %>% 
   filter(tier_zero_risk_f == "Red Criteria Passed") %>% 
  #Remove leachate and additive/chemical transfer experiments
  replace_na(list(chem.exp.typ.nominal = "Particle Only")) %>% 
  dplyr::filter(leachate.only != "Y") %>%
  mutate(chem.exp.typ.nominal_f = factor(case_when(chem.exp.typ.nominal == "Particle Only" ~ "Particle Only",
                                                   chem.exp.typ.nominal == "co.exp" ~ "Chemical Co-Exposure",
                                                   chem.exp.typ.nominal == "sorbed" ~ "Chemical Transfer"))) %>% 
  dplyr::filter(chem.exp.typ.nominal_f == "Particle Only") %>% 
  #Select NOECs/LOECs
  filter(effect.metric == c("NOEC", "LOEC")) %>%
  #Select data where acute and chronic exposure is defined
  filter(acute.chronic_f == c("Acute", "Chronic")) %>%
  filter(size_f != "Not Reported") %>% 
  #Drop rows where there is no dosing data in mass per volume
  drop_na(dose.mg.L.master) %>%
  #Group the data by organism group and acute vs chronic data 
  group_by(org_f, acute.chronic_f, effect.metric, lvl1_f) %>% 
           #size_f) 
  droplevels() %>% 
  #Create a new column for the average effect for each combination of the matrix
  summarise(meanEffect = mean(dose.mg.L.master))

grouped
```

```{r}
#create unique ID for each combo of interest for NOECs and LOECs
NOEC <- grouped %>% 
  mutate(combo = paste(org_f, acute.chronic_f, lvl1_f)) %>% 
  filter(effect.metric == "NOEC") %>% 
  mutate(effectNOEC = meanEffect)

LOEC <- grouped %>% 
  mutate(combo = paste(org_f, acute.chronic_f, lvl1_f)) %>% 
  filter(effect.metric == "LOEC") %>% 
  mutate(effectLOEC = meanEffect)

# join NOEC and LOEC dataframes and compute LOEC/NOEC ratio for each combo
NOEC.LOEC <- full_join(NOEC, LOEC, by = "combo") %>%
  select(c(combo,effectNOEC, effectLOEC)) %>% 
  mutate(LOEC.NOEC.ratio = effectLOEC / effectNOEC) %>% 
  drop_na()

NOEC.LOEC
```
```{r}
summary(lm(effectNOEC ~ effectLOEC, data = NOEC.LOEC))

NOEC.LOEC %>% 
  #filter(LOEC.NOEC.ratio <10) %>% 
  #filter(LOEC.NOEC.ratio >10) %>% 
  ggplot(aes(x = effectNOEC, y = effectLOEC)) +
  geom_point() +
  geom_smooth(method = "lm")
```


# ```{r}
# #create grid of all possible combinations of levels for available factors
# lvl1 <- levels(grouped$lvl1_f)
# effect.metric <- levels(grouped$effect.metric)
# org <- levels(grouped$org_f)
# #species <- levels(grouped$species_f)
# size <- levels(grouped$size_f)
# acute.chronic <- levels(grouped$acute.chronic_f)
# 
# grid <- tidyr::expand_grid(lvl1, effect.metric, 
#                    #species, 
#                    org,
#                    size, acute.chronic)
# 
# # Create unique identifier for each combination of variables in grid and in summarized dataframe
# grid2 <- grid %>% 
#   mutate(ID = paste(lvl1, effect.metric, org, size, acute.chronic))
# 
# grouped2 <- grouped %>% 
#   mutate(ID = paste(lvl1_f, effect.metric, org_f, size_f, acute.chronic_f))
# 
# # join dataset to complete grid
# left_join(grid2, grouped2, by = "ID") %>%  drop_na(meanEffect)
# 
# ```


```{r}
grouped %>% 
  filter(meanEffect < 5E3) %>% 
  ggplot(aes(x = meanEffect, y = effect.metric, color = acute.chronic_f)) +
  scale_x_log10() +
  geom_point()
```


```{r}
#alt approach 
filtered <- aoc_z %>% 
  #Remove leachate and additive/chemical transfer experiments
  replace_na(list(chem.exp.typ.nominal = "Particle Only")) %>% 
  dplyr::filter(leachate.only != "Y") %>%
  mutate(chem.exp.typ.nominal_f = factor(case_when(chem.exp.typ.nominal == "Particle Only" ~ "Particle Only",
                                                   chem.exp.typ.nominal == "co.exp" ~ "Chemical Co-Exposure",
                                                   chem.exp.typ.nominal == "sorbed" ~ "Chemical Transfer"))) %>% 
  dplyr::filter(chem.exp.typ.nominal_f == "Particle Only") %>% 
  #Select NOECs/LOECs
  filter(effect.metric == c("NOEC", "LOEC")) %>%
  #Select data where acute and chronic exposure is defined
  filter(acute.chronic_f == c("Acute", "Chronic")) %>%
  filter(size_f != "Not Reported") %>% 
  #Drop rows where there is no dosing data in mass per volume
  drop_na(dose.mg.L.master) %>%
  droplevels()

summary(lm(dose.mg.L.master ~ effect.metric + lvl2_f + size_f + species_f + life.stage, 
   data = filtered))
```
```{r}
filtered %>% 
  ggplot(aes(y = dose.mg.L.master, x = effect.metric)) +
  geom_boxplot() +
  scale_y_log10()
```

