---
title: "Global Microplastics Risk Characterization"
author: "Scott Coffin"
date: "3/10/2021"
output:   
  html_document:
    code_folding: hide
    theme: journal
    toc: yes
    toc_float: yes
    toc_depth: 6
    number_sections: true
    includes:
     # after_body: footer.html
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      warning=FALSE, message=FALSE,time_it = TRUE) #report
```

```{r}
library(tidyverse)
library(calecopal)
library(ssdtools)
library(DT)
library(plotly)
library(gridExtra)
library(grid)
library(wesanderson)
library(ggdark)
library(broom)
library(knitr)
library(ggdark)
library(viridis)
```

# Hazard Concentration and Alignment Parameters
```{r}
###### Choose concentration alignment parameters####
alpha = 2.07 #personal comm. with Bart suggests 2.07 for marine surface water #(use 1.6 or 2.5)
x2D_set = 5000 #100 #upper size range (microns)
x1D_set = 1 #1 #lower size range (microns)

#### Choose assessment factor ####
AF = 1#5

##### Choose hazard concentration and confidence intervals####
#particles/L
Threshold1 = 0.89 / AF
Threshold2 = 18 / AF
Threshold3 = 30 / AF
Threshold4 = 140 / AF
```

```{r Theme, include=FALSE}
#Theme type
     theme.type <- #theme_gray(base_size = 20)#,
                       dark_theme_bw(base_size = 18)
     #color selection
     fill.type <-    scale_fill_viridis(discrete = TRUE)#,
                         #scale_fill_brewer(palette = "Paired"),
                         # scale_fill_tron(),
                         # scale_fill_locuszoom(),
                         # scale_fill_d3(),
                         # scale_fill_npg(),
                         # scale_fill_jama())
     #color selection
     color.type <- scale_color_viridis(discrete = TRUE)#,
                         # scale_color_brewer(palette = "Paired"),
                         # scale_color_tron(),
                         # scale_color_locuszoom(),
                         # scale_color_d3(),
                         # scale_color_npg(),
                         # scale_color_jama())

```



```{r}
# print table
kable(data.frame(
  Category = c("Hazard Concentrations (particles/L)"),
  "Threshold1" = Threshold1,
  "Threshold 2" = Threshold2,
  "Threshold 3" = Threshold3,
  "Threshold 4" = Threshold4))
```

```{r}
#print table of sizes
kable(data.frame(
  Category = c("Concentration Alignment Parameters"),
  alpha = alpha,
  "lower_size_range_microns" = x1D_set,
  "upper_size_range_microns" = x2D_set))
```

```{r}
#data import
# Adam et al (2019) data needs correcting
adam <- read.csv("Concentration Data/Datasets/adam2019.csv", na.strings = "N.A.") %>% 
  rename(Sampling.apparatus = ï..Sampling.apparatus) %>% 
  mutate(x1M = Min.particle.size.um,
         x2M = Max.particle.size.um) %>% 
  mutate(Sample.Type = "sample")

#SF bay data from Zhu et al (2021)
sfBay <- read.csv("Concentration Data/Datasets/SFBayData.csv", na.strings = "NA", stringsAsFactors = TRUE) %>%
  rename(sampleID = ï..sampleID,
          x1M = Min.particle.size.um,
         x2M = Max.particle.size.um) %>% 
  mutate(Sample.Type = "sample")

```

## Size-based Correction
Given an upper limit (UL) and lower limit (LL) of the measured and default size range, a dimensionless correction factor ($CF_{meas}$) for measured environmental concentrations may be calculated, which rescales the measured number concentrations for a certain size range to the number concentration for the microplastics default (D) size range (e.g. 1 to 5,000 um) (Koelmans et al 2020). Coefficients for the environmental-specific compartment for the power law distribution for length (L) with slope $\alpha_L$ is from Table S4 of Kooi et al (2021). 

$CF_{Meas} = \frac{L^{1-a}_{UL,D} - L^{1-a}_{LL,D}}{L^{1-a}_{UL,M} - L^{1-a}_{LL,M}}$

```{r}
# Align Data

#function to derive correction factor (CF) from Koelmans et al (equation 2)
CFfnx = function(a = alpha, #default alpha from Koelmans et al (2020)
                 x2D = x2D_set, #set detault values to convert ranges to (1-5,000 um) #5mm is upper defuault 
                 x1D = x1D_set, #1 um is lower default size
                 x2M, x1M){
  
  CF = (x2D^(1-a)-x1D^(1-a))/(x2M^(1-a)-x1M^(1-a))
  
  return(CF)
}
#verify it works (expected answer is 40.37)
#CFfnx(x1M = 333, x2M = 5000)

adam <- adam %>% 
  mutate(CF = CFfnx(x1M = x1M, x2M = x2M)) %>%  #create new column with correction factor 
  mutate(particles.m3.corrected = CF * Single.Measurement.conc....m3.) %>% #convert single concenetrations
  mutate(particles.m3.corrected_mean = CF * Mean.conc....m3.) %>%  #convert mean concentrations from distributions
  mutate(particles.m3.corrected_median = CF * Median.conc....m3.) %>%   #convert mean concentrations from distributions
  mutate(particles.single.median.m3 = ifelse(is.na(particles.m3.corrected), particles.m3.corrected_median, particles.m3.corrected)) %>% 
  mutate(particles.m3.master = ifelse(is.na(particles.single.median.m3), particles.m3.corrected_mean, particles.single.median.m3)) %>% 
  mutate(particle.L.master = particles.m3.master/1000) %>% 
  filter(particle.L.master > 0) %>% 
  mutate(System = factor(System)) %>% 
  mutate(source = "Adam")

# correct aquatic concentrations for SF Bay
sfBay <- sfBay %>% 
  mutate(CF = CFfnx(x1M = x1M, x2M = x2M)) %>%  #create new column with correction factor 
  mutate(particle.L.master = particles.L.blank.corrected * CF) %>% 
  mutate(source = "SFEI") %>% 
  mutate(Reference = "Zhu et. al 2021") %>% 
  rename(Sampling.location = general.location) %>% 
  select(-c(particles.L.blank.corrected, particles.kg.blank.corrected, particles.fish.blank.corrected))

## join datasets ##
#first ensure that both datasets share all columns
adam_sub <- adam %>% 
  select(c(Sampling.apparatus, Sampling.location, x1M, x2M, Sample.Type, System, CF,particle.L.master, source, Reference)) %>% 
  mutate(sampleID = NA,
         specific.location = NA,
         latitude = NA,
         longitude = NA,
         sample.matrix = "water",
         sample.matrix.specific = "surface water"
         )

#join data
globalData <- rbind(adam_sub, sfBay) %>% 
  mutate(Conc = particle.L.master) %>% 
  mutate_if(is.character, as.factor)
```

## Global Exceedances
```{r}
#make new dataframe to plot both histograms together
sampleSimpleADAM <- globalData %>%
  filter(sample.matrix.specific == "surface water") %>% 
  drop_na(Conc) %>% 
  droplevels()

#make new dataframe to plot both histograms together
dfADAM <- rbind(sampleSimpleADAM)#,food.dilution.simple)

#calculate exceedance
dfADAM_exceedance <- dfADAM %>% 
  mutate(aboveThreshold = factor(case_when(
    Conc < Threshold1 ~ "below Threshold 1",
    Conc >= Threshold1 & Conc < Threshold2 ~ "above Threshold 1",
    Conc >= Threshold2 & Conc < Threshold3 ~ "above Threshold 2",
    Conc >= Threshold3 & Conc < Threshold4 ~ "above Threshold 3",
    Conc >= Threshold4 ~ "above Threshold 4"
  )))

#give summary stat for exceedance
exceedance <- dfADAM_exceedance  %>%
  filter(Sample.Type == "sample") %>% 
  dplyr::select(c(Conc, aboveThreshold)) %>%
  group_by(aboveThreshold) %>%
  dplyr::summarize(n = n()) %>% 
  mutate(rel.freq = paste0(round(100 * n/sum(n), 0), "%"))

kable(exceedance)
```
### Concentrations Histogram
```{r}
binwidth <- 0.25

globalData %>% 
  ggplot(aes(x = particle.L.master,
             fill = source,
            # color = source, 
             binwidth = binwidth)) +
  # geom_histogram(aes(y = ..count.. / (sum(..count..) * binwidth)), 
  #                binwidth = binwidth,
  #                alpha = 0.9,
  #                position = "stack") +
  geom_density( alpha = 0.6, lwd = 0.8, adjust = 0.6) +
  scale_fill_manual(name = "Location", labels = c("Global (no CA data)", "San Francisco Bay"),
                   values = c("#00798c", "#d1495b")) +
  scale_x_continuous(name = "Particles/L",breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif, trans = "log10")+
  ylab("Normalized Abundance") +
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  labs(title = "Global Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("n = 24 studies, 77 sampling locations, n_samples = 484; corrected for size, blanks. Alpha = ",alpha))+
  theme.type +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        axis.text =  element_text(size = 16),
        legend.text = element_text(size =14),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```
### Concentrations boxplot
```{r}
binwidth <- 0.25

globalData %>% 
  ggplot(aes(x = particle.L.master,
             fill = source,
            # color = source, 
             binwidth = binwidth)) +
 geom_boxplot() +
  scale_fill_manual(name = "Location", labels = c("Global (no CA data)", "San Francisco Bay"),
                    values = c("#00798c", "#d1495b")) +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif, trans = "log10")+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  labs(title = "Global Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("n = 24 studies, 77 sampling locations, n_samples = 559; corrected for size, blanks. Alpha = ",alpha))+
  theme.type +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        axis.text =  element_text(size = 16),
        legend.text = element_text(size =14),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```

### Risk Characterization Histogram (Global)
```{r}
#generate plot
dfADAM_exceedance %>% 
  filter(Conc > 0) %>% 
  filter(Sample.Type == "sample") %>% 
  ggplot(aes(x = Conc, fill = aboveThreshold))+
  geom_histogram(aes(y = ..count../sum(..count..)),bins = 50, alpha = 0.9, position = "identity") +
  #geom_text(aes(x = Threshold1- 0.5*Threshold1, y = 0.045), label = paste(Threshold1,"particles/L"),  color = "goldenrod2") +
  #geom_text(aes(x = Threshold1- 0.5*Threshold1, y = 0.055), label = ("Threshold1"),  color = "goldenrod2") +
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'goldenrod2', size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'tomato1', size = 1.3) +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'mediumvioletred', size = 1.3) +
  geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'gray33', size = 1.3) +
  #geom_text(label = "Threshold 1", color = 'goldenrod2', x = log10(Threshold1) - 0.8*log10(Threshold1), y = 0.055, size = 6)+
#   geom_text(label = "Threshold 2", color = 'tomato1', x = log10(Threshold2) - 0.8*log10(Threshold2), y = 0.055, size = 6)+
 #  geom_text(label = "Threshold 3", color = 'mediumvioletred', x = log10(Threshold3) - 0.8*log10(Threshold3), y = 0.055, size = 6)+
  # geom_text(label = "Threshold 4", color = 'gray33', x = Threshold4 - 0.8*log10(Threshold4), y = 0.055, size = 6)+
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif, trans = "log10")+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  #coord_cartesian(xlim = c(0,100000000)) +
  #scale_x_continuous(labels = scales::scientific) +
   xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "um)")) +
  scale_y_continuous(name = "Relative Density", labels = scales::percent)+
  scale_fill_manual(values = c("below Threshold 1"= "cyan3", 
                               "above Threshold 1" = "goldenrod2", 
                               "above Threshold 2" = "tomato1",
                               "above Threshold 3" = "violetred4", 
                               "above Threshold 4" = "gray33")) +
  labs(title = "Global Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("Concentration data from 24 studies, 77 sampling locations, n = 559; corrected for size, blanks. Alpha = ",alpha))+
  theme.type +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        axis.text =  element_text(size = 16),
        legend.text = element_text(size =14),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```

### SFBay Exceedances
```{r}
#make new dataframe to plot both histograms together
sampleSimpleSFEI <- globalData %>%
  filter(source == "SFEI") %>% 
  filter(sample.matrix.specific == "surface water") %>% 
  drop_na(Conc) %>% 
  droplevels()

#make new dataframe to plot both histograms together
dfSFEI <- rbind(sampleSimpleSFEI)#,food.dilution.simple)


#calculate exceedance
dfSFEI_exceedance <- dfSFEI %>% 
  mutate(aboveThreshold = factor(case_when(
    Conc < Threshold1 ~ "below Threshold 1",
    Conc >= Threshold1 & Conc < Threshold2 ~ "above Threshold 1",
    Conc >= Threshold2 & Conc < Threshold3 ~ "above Threshold 2",
    Conc >= Threshold3 & Conc < Threshold4 ~ "above Threshold 3",
    Conc >= Threshold4 ~ "above Threshold 4"
  )))

#give summary stat for exceedance
exceedance <- dfADAM_exceedance  %>%
  filter(Sample.Type == "sample") %>% 
  dplyr::select(c(Conc, aboveThreshold)) %>%
  group_by(aboveThreshold) %>%
  dplyr::summarize(n = n()) %>% 
  mutate(rel.freq = paste0(round(100 * n/sum(n), 0), "%"))

kable(exceedance)
```

### Risk Characterization Histogram (SFBay)
```{r}
#generate plot
dfSFEI_exceedance %>% 
 # filter(Conc > 0) %>% 
  filter(Sample.Type == "sample") %>% 
  ggplot(aes(x = Conc, fill = aboveThreshold))+
  geom_histogram(aes(y = ..count../sum(..count..)),bins = 40, alpha = 0.9, position = "identity") +
  #geom_text(aes(x = Threshold1- 0.5*Threshold1, y = 0.045), label = paste(Threshold1,"particles/L"),  color = "goldenrod2") +
  #geom_text(aes(x = Threshold1- 0.5*Threshold1, y = 0.055), label = ("Threshold1"),  color = "goldenrod2") +
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'goldenrod2', size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'tomato1', size = 1.3) +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'mediumvioletred', size = 1.3) +
  geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'gray33', size = 1.3) +
  #geom_text(label = "Threshold 1", color = 'goldenrod2', x = log10(Threshold1) - 0.8*log10(Threshold1), y = 0.055, size = 6)+
#   geom_text(label = "Threshold 2", color = 'tomato1', x = log10(Threshold2) - 0.8*log10(Threshold2), y = 0.055, size = 6)+
 #  geom_text(label = "Threshold 3", color = 'mediumvioletred', x = log10(Threshold3) - 0.8*log10(Threshold3), y = 0.055, size = 6)+
  # geom_text(label = "Threshold 4", color = 'gray33', x = Threshold4 - 0.8*log10(Threshold4), y = 0.055, size = 6)+
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif, trans = "log10")+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  #coord_cartesian(xlim = c(0,100000000)) +
  #scale_x_continuous(labels = scales::scientific) +
   xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "um)")) +
  scale_y_continuous(name = "Relative Density", labels = scales::percent)+
  scale_fill_manual(values = c("below Threshold 1"= "cyan3", 
                               "above Threshold 1" = "goldenrod2", 
                               "above Threshold 2" = "tomato1",
                               "above Threshold 3" = "violetred4", 
                               "above Threshold 4" = "gray33")) +
  labs(title = "San Francisco Bay Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("n = 107; corrected for size, blanks. Alpha = ",alpha))+
  theme.type +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        axis.text =  element_text(size = 16),
        legend.text = element_text(size =14),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```

### ECDF (Global)

```{r}
#ECDF by System
adam %>% 
filter(System != "") %>% 
  ggplot(aes(x = particle.L.master)) + #, color = System))+
  stat_ecdf(geom = "point", size = 1, alpha = 0.7) +
  stat_ecdf(geom = "step", linetype = 'solid', alpha = 0.3, size = 1.5, color = 'azure3') +
  scale_color_manual(values = wes_palette("Darjeeling1"))+
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'green', size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'yellow', size = 1.3) +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'orange', size = 1.3) +
  geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'red', size = 1.3) +
  geom_text(label = "Threshold 1", color = 'green', x = Threshold1, y = 0.15, size = 6)+
  geom_text(label = "Threshold 2", color = 'yellow', x = Threshold2, y = 0.22, size = 6)+
  geom_text(label = "Threshold 3", color = 'orange', x = Threshold3, y = 0.35, size = 6)+
  geom_text(label = "Threshold 4", color = 'red', x = Threshold4, y = 0.45, size = 6)+
  ylab("Cumulative Density") +
  xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "um)"))+
  scale_y_continuous(labels = scales::percent)+
  coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  theme.type +
  labs(title = "Global Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("Concentration data from Adams et al (2019): 23 studies, 57 sampling locations, n = 377; corrected for size ranges. Alpha = ",alpha))+
  theme(
    plot.title = element_text(hjust = 0.5, size = 18),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```

### ECDF (SFEI by Matrix)
```{r}
globalData %>% 
  filter(source == "SFEI") %>% 
  filter(sample.matrix == "water") %>% 
  drop_na(particle.L.master) %>% 
  ggplot(aes(x = log10(particle.L.master), color = sample.matrix.specific))+
  stat_ecdf(geom = "point", size = 1, alpha = 0.7) +
  stat_ecdf(geom = "step", linetype = 'solid', alpha = 0.5, size = 1.5) +
  scale_color_manual(name = "Matrix",values = wes_palette("Darjeeling1"))+
  # geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'green', size = 1.3) +
  # geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'yellow', size = 1.3) +
  # geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'orange', size = 1.3) +
  # geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'red', size = 1.3) +
  # geom_text(label = "Threshold 1", color = 'green', x = Threshold1, y = 0.15, size = 6)+
  # geom_text(label = "Threshold 2", color = 'yellow', x = Threshold2, y = 0.22, size = 6)+
  # geom_text(label = "Threshold 3", color = 'orange', x = Threshold3, y = 0.35, size = 6)+
  # geom_text(label = "Threshold 4", color = 'red', x = Threshold4, y = 0.45, size = 6)+
  scale_y_continuous(labels = scales::percent)+
  #coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  ylab("Cumulative Density") +
  xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, " um)"))+
  theme.type +
  labs(title = "San Francisco Bay Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("Concentration data from Zhu et al (2021): 29 sampling locations, n = 136; corrected for size ranges. Alpha = ",alpha))+
  theme(
    plot.title = element_text(hjust = 0.5, size = 18),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```

### ECDF (SFEI by Mesh Size)
```{r}
globalData %>% 
  filter(source == "SFEI") %>% 
  filter(sample.matrix == "water") %>% 
  drop_na(particle.L.master) %>% 
  ggplot(aes(x = log10(particle.L.master), color = Sampling.apparatus))+
  stat_ecdf(geom = "point", size = 1, alpha = 0.7) +
  stat_ecdf(geom = "step", linetype = 'solid', alpha = 0.5, size = 1.5) +
  scale_color_manual(name = "Matrix",values = wes_palette("Darjeeling1"))+
  # geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'green', size = 1.3) +
  # geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'yellow', size = 1.3) +
  # geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'orange', size = 1.3) +
  # geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'red', size = 1.3) +
  # geom_text(label = "Threshold 1", color = 'green', x = Threshold1, y = 0.15, size = 6)+
  # geom_text(label = "Threshold 2", color = 'yellow', x = Threshold2, y = 0.22, size = 6)+
  # geom_text(label = "Threshold 3", color = 'orange', x = Threshold3, y = 0.35, size = 6)+
  # geom_text(label = "Threshold 4", color = 'red', x = Threshold4, y = 0.45, size = 6)+
  scale_y_continuous(labels = scales::percent)+
  #coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  ylab("Cumulative Density") +
  xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, " um)"))+
  theme.type +
  labs(title = "San Francisco Bay Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("Concentration data from Zhu et al (2021): 29 sampling locations, n = 136; corrected for size ranges. Alpha = ",alpha))+
  theme(
    plot.title = element_text(hjust = 0.5, size = 18),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```

### Boxplot SFEI
```{r}
globalData %>% 
  filter(source == "SFEI") %>% 
  filter(sample.matrix == "water") %>% 
  drop_na(particle.L.master) %>% 
  ggplot(aes(y = particle.L.master, x = sample.matrix.specific))+
  geom_boxplot(alpha = 0.4) +
  geom_point(aes(color = Sampling.apparatus)) +
  scale_color_manual(name = "Sampling Apparatus",values = wes_palette("Darjeeling1"))+
   # geom_hline(yintercept = Threshold1, linetype = 'dashed', color = 'green', size = 1) +
   # geom_hline(yintercept = Threshold2, linetype = 'dashed', color = 'yellow', size = 1) +
   # geom_hline(yintercept = Threshold3, linetype = 'dashed', color = 	'orange', size = 1) +
   # geom_hline(yintercept = Threshold4, linetype = 'dashed', color = 	'red', size = 1) +
  # geom_text(label = "Threshold 1", color = 'green', x = Threshold1, y = 0.15, size = 6)+
  # geom_text(label = "Threshold 2", color = 'yellow', x = Threshold2, y = 0.22, size = 6)+
  # geom_text(label = "Threshold 3", color = 'orange', x = Threshold3, y = 0.35, size = 6)+
  # geom_text(label = "Threshold 4", color = 'red', x = Threshold4, y = 0.45, size = 6)+
  scale_y_log10(breaks = scales::trans_breaks("log10", function(y) 10^y),labels = comma_signif)+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  ylab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, " um)"))+
  theme.type +
  labs(title = "San Francisco Bay Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("Concentration data from Zhu et al (2021): 29 sampling locations, n = 136; corrected for size ranges. Alpha = ",alpha))+
  theme(
    plot.title = element_text(hjust = 0.5, size = 18),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```

## Modelling

```{r eval=FALSE, include=FALSE}
surfaceData <- globalData %>% 
  filter(sample.matrix.specific == "surface water") %>% 
  dplyr::select(Conc) %>% 
  drop_na(Conc)

sample_dists_ADAM <- ssd_fit_dists(surfaceData, #data frame
                              left = "Conc", #string of the column in data with the concentrations
                              # right = left, #string of the column with the right concentration values. If different from left, then the data are considerd to be censored
                              dists = c("weibull", "llogis", "lnorm", "gamma", "lgumbel"), #char vector of distribution anmes
                              computable = FALSE, #flag specifying whether to only return fits with numerically computable standard errors
                              silent = FALSE) #flag indicating whether fits should fail silently

autoplotADAM<- autoplot(sample_dists_ADAM) #plots the distribution in ggplot2
autoplotADAM
ssd_gof(sample_dists_ADAM) #check the goodness of fit
#there are multiple fitting distributions, so check which fits best
sample_gof_ADAM <- ssd_gof(sample_dists_ADAM)
sample_gof_ADAM[order(sample_gof_ADAM$delta), ] #orders by delta. Use the aicc (Akaike's Information Criterion corrected for sample size) for model selection 
write.csv(sample_gof_ADAM,"Concentration data/sample_gof_ADAM.csv")
#choose the distribution that you want to plot
sample_dists_ADAM_choice <- ssd_fit_dists(samplesADAM, #data frame
                                   left = "Conc", #string of the column in data with the concentrations
                                   # right = left, #string of the column with the right concentration values. If different from left, then the data are considerd to be censored
                                   dists = c("lgumbel"), #char vector of distribution anmes
                                   computable = FALSE, #flag specifying whether to only return fits with numerically computable standard errors
                                   silent = FALSE) #flag indicating whether fits should fail silently
set.seed(99)
sample_pred_ADAM <- predict(sample_dists_ADAM_choice,
                       average = FALSE,
                       ic = "aicc",
                       nboot = 10,
                       ci= TRUE) #estimates model-averaged estimates based on aicc

sample_pred_ADAM # The resultant object is a data frame of the estimated concentration (est) with standard error (se) and lower (lcl) and upper (ucl) 95% confidence limits by percent of species affected (percent). The confidence limits are estimated using parametric bootstrapping.

```

```{r eval=FALSE, include=FALSE}
sample_pred_ADAM %>% mutate_if(is.numeric, ~ signif(., 3)) %>% 
  datatable(rownames = FALSE,
            extensions = c('Buttons', 'Scroller'),
            options = list(
              dom = 'Brftp',
              scrollY = 400,
              scroller = TRUE,
              buttons = c('copy', 'csv', 'excel')), 
            class = "compact",
            colnames = c("Percent", "Estimated Mean Concentration", "Standard Error", "Lower 95% Confidence Limit", "Upper 95% Confidence Limit", "Distribution"),
            caption = "Predicted Concentration distribution with uncertanties."
  )

#order data
samplesADAM <- samplesADAM %>% 
  filter(System != "") #take out blanks

sampleSSDADAM <- samplesADAM[order(samplesADAM$Conc), ]
sampleSSDADAM$frac <- ppoints(samplesADAM$Conc, 0.5)
```


```{r eval=FALSE, include=FALSE}
ECDF_model_occurrence_ADAM <- ggplot(sample_pred_ADAM,aes_string(x = "est")) +
  geom_xribbon(aes_string(xmin = "lcl", xmax = "ucl", y = "percent/100"), alpha = 0.2, color = "#81a88d", fill = "#81a88d") +
  geom_line(aes_string(y = "percent/100"), linetype = 'dashed', alpha = 0.8) +
  geom_point(data = sampleSSDADAM,aes(x = Conc, y =frac, color = System), size =1) + 
  #geom_text(data = sampleSSD, aes(x = Conc, y = frac, label = Location), hjust = 1.1, size = 4) + #season labels
  scale_y_continuous("Cumulative Distribution (%)", labels = scales::percent) +
  #expand_limits(y = c(0, 1)) +
  xlab("Concentration (particles/L)")+
  labs(title = "Adam et al 2019 Microplastics Concentration Cumulative Distribution Function",
       subtitle = "Smoothing/95% CI ribbon based on average of log-logical and log-normal Distributions Fit",
       caption = "Adam et al 2019 data; sampling corrected to 1-5,000 um") +
  coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  scale_color_manual(values = wes_palette("Darjeeling2"))

#white mode
ECDF_model_occurrence_ADAM_white <- ECDF_model_occurrence_ADAM +
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'red') +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 'red') +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 	'red') +
  geom_text(label = "5% HC: 95% LCL", color = 'red', x = Threshold3, y = 0)+
  geom_text(label = "5% hazard concentration", color = 'red', x = 110, y = 0.03)+
  geom_text(label = "5% HC: 95% UCL", color = 'red', x = Threshold2, y = 0)+
  geom_text(x = 110, y = 0, label = paste(Threshold1,"particles/L"), color = 'red') +  #label for hazard conc
  #geom_hline(yintercept = 0.925, linetype = 'twodash', color = "#A2A475") +
  #geom_text(label = "92.5% samples below 5% HC Mean", x = 4.5, y = 0.94, color = "#A2A475") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))
ECDF_model_occurrence_ADAM_white

```

```{r eval=FALSE, include=FALSE}
#dark mode
ECDF_model_occurrence_ADAM_dark <- ECDF_model_occurrence_ADAM +
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'goldenrod2', size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'tomato1', size = 1.3) +
 geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'mediumvioletred', size = 1.3) +
 geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'gray33', size = 1.3) +
  #geom_text(x = Threshold1, y = 0.1, label = paste(Threshold1,"particles/L"), color = 'red', size =5) +  #label for hazard conc
  #geom_hline(yintercept = 0.925, linetype = 'twodash', color = "yellow") +
  #geom_text(label = "92.5%", x = 3.0, y = 0.96, color = "yellow", size = 6) +
  theme.type +
  theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))
ECDF_model_occurrence_ADAM_dark
```

# SFEI Data (uncorrected for blanks, do not use)
```{r eval=FALSE, include=FALSE}
# SFEI data
sfei <- read.csv("Concentration data/Datasets/SFEI.csv", na.strings = "N.A.") %>% 
  #filter(Below_LOD == "N") %>% 
  # align data
  mutate(x1M = 20,
         x2M = 5000) %>% 
  mutate(CF = CFfnx(x1M = x1M, x2M = x2M)) %>%  #create new column with correction factor 
  mutate(particle.L.master = CF * Particles.L_uncorrected)

# read in concentration data
samplessfei <- sfei %>% 
  mutate(Conc = particle.L.master)

#make new dataframe to plot both histograms together
sampleSimplesfei <- samplessfei %>%
  dplyr::select(Conc, Sample.Type) %>% 
  droplevels()

#make new dataframe to plot both histograms together
dfsfei <- rbind(sampleSimplesfei)#,food.dilution.simple)
```


## Exceedances
```{r eval=FALSE, include=FALSE}
#calculate exceedance
dfsfei_exceedance <- dfsfei %>% 
  mutate(aboveThreshold = factor(case_when(
    Conc < Threshold1 ~ "below Threshold 1",
    Conc >= Threshold1 & Conc < Threshold2 ~ "above Threshold 1",
    Conc >= Threshold2 & Conc < Threshold3 ~ "above Threshold 2",
    Conc >= Threshold3 & Conc < Threshold4 ~ "above Threshold 3",
    Conc >= Threshold4 ~ "above Threshold 4"
  )))

#give summary stat for exceedance
exceedance <- dfsfei_exceedance  %>%
  filter(Sample.Type == "sample") %>% 
  dplyr::select(c(Conc, aboveThreshold)) %>%
  group_by(aboveThreshold) %>%
  dplyr::summarize(n = n()) %>% 
  mutate(rel.freq = paste0(round(100 * n/sum(n), 0), "%"))

kable(exceedance)
```
## Histogram
```{r eval=FALSE, include=FALSE}
#generate plot
dfsfei_exceedance %>% 
  filter(Conc > 0) %>% 
  filter(Sample.Type == "sample") %>% 
  ggplot(aes(x = Conc, fill = aboveThreshold))+
  geom_histogram(aes(y = ..count../sum(..count..)),bins =30, alpha = 0.9, position = "identity") +
  #geom_text(aes(x = Threshold1- 0.5*Threshold1, y = 0.045), label = paste(Threshold1,"particles/L"),  color = "goldenrod2") +
  #geom_text(aes(x = Threshold1- 0.5*Threshold1, y = 0.055), label = ("Threshold1"),  color = "goldenrod2") +
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'goldenrod2', size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'tomato1', size = 1.3) +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'mediumvioletred', size = 1.3) +
  geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'gray33', size = 1.3) +
  #geom_text(label = "Threshold 1", color = 'goldenrod2', x = log10(Threshold1) - 0.8*log10(Threshold1), y = 0.055, size = 6)+
#   geom_text(label = "Threshold 2", color = 'tomato1', x = log10(Threshold2) - 0.8*log10(Threshold2), y = 0.055, size = 6)+
 #  geom_text(label = "Threshold 3", color = 'mediumvioletred', x = log10(Threshold3) - 0.8*log10(Threshold3), y = 0.055, size = 6)+
  # geom_text(label = "Threshold 4", color = 'gray33', x = Threshold4 - 0.8*log10(Threshold4), y = 0.055, size = 6)+
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif, trans = "log10")+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  #coord_cartesian(xlim = c(0,100000000)) +
  #scale_x_continuous(labels = scales::scientific) +
   xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "um)")) +
  scale_y_continuous(name = "Relative Density", labels = scales::percent)+
  scale_fill_manual(values = c("below Threshold 1"= "cyan3", 
                               "above Threshold 1" = "goldenrod2", 
                               "above Threshold 2" = "tomato1",
                               "above Threshold 3" = "violetred4", 
                               "above Threshold 4" = "gray33")) +
  labs(title = "SF Bay and Sanctuary Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("Concentration data from sfeis et al (2019): 23 studies, 57 sampling locations, n = 377; corrected for size ranges. Alpha = ",alpha))+
  theme.type +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        axis.text =  element_text(size = 16),
        legend.text = element_text(size =14),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```
## ECDF

```{r eval=FALSE, include=FALSE}
#ECDF by System
sfei %>% 
filter(System != "") %>% 
  ggplot(aes(x = particle.L.master)) + #, color = System))+
  stat_ecdf(geom = "point", size = 1, alpha = 0.7) +
  stat_ecdf(geom = "step", linetype = 'solid', alpha = 0.3, size = 1.5, color = 'azure3') +
  scale_color_manual(values = wes_palette("Darjeeling1"))+
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'green', size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'yellow', size = 1.3) +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'orange', size = 1.3) +
  geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'red', size = 1.3) +
  geom_text(label = "Threshold 1", color = 'green', x = Threshold1, y = 0.15, size = 6)+
  geom_text(label = "Threshold 2", color = 'yellow', x = Threshold2, y = 0.22, size = 6)+
  geom_text(label = "Threshold 3", color = 'orange', x = Threshold3, y = 0.35, size = 6)+
  geom_text(label = "Threshold 4", color = 'red', x = Threshold4, y = 0.45, size = 6)+
  ylab("Cumulative Density") +
  xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "um)"))+
  scale_y_continuous(labels = scales::percent)+
  coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  theme.type +
  labs(title = "Global Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("Concentration data from sfeis et al (2019): 23 studies, 57 sampling locations, n = 377; corrected for size ranges. Alpha = ",alpha))+
  theme(
    plot.title = element_text(hjust = 0.5, size = 18),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```


