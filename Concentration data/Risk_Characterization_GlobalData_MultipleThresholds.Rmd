---
title: "Global Microplastics Risk Characterization"
author: "Scott Coffin"
date: "3/10/2021"
output:   
  html_document:
    code_folding: hide
    theme: journal
    toc: yes
    toc_float: yes
    toc_depth: 6
    number_sections: true
    includes:
     # after_body: footer.html
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      warning=FALSE, message=FALSE,time_it = TRUE) #report
```

```{r}
library(tidyverse)
library(calecopal)
library(ssdtools)
library(DT)
library(plotly)
library(gridExtra)
library(grid)
library(wesanderson)
library(ggdark)
library(broom)
library(knitr)
library(ggdark)
library(viridis)
library(ggpubr)
library(ggsci)
#library(overlapping)
```

# Hazard Concentration and Alignment Parameters
```{r}
###### Choose concentration alignment parameters####
alpha.marine = 2.07 #table s4 for marine surface water. length
alpha.freshwater = 2.64 #table s4 for freshwater surface water. length

x2D_set = 5000 #100 #upper size range (microns)
x1D_set = 1 #1 #lower size range (microns)

#### Choose assessment factor ####
AF = 1#5

##### Choose hazard concentration and confidence intervals####
#particles/L
Threshold1 = 0.34 / AF
Threshold2 = 5.2 / AF
Threshold3 = 21.8 / AF
Threshold4 = 89.9 / AF

#Food dilution
Threshold1_food = 0.34 / AF
Threshold2_food = 5.2 / AF
Threshold3_food = 21.8 / AF
Threshold4_food = 89.9 / AF

#Oxidative stress
Threshold1_oxidative.stress = 35.3 / AF
Threshold2_oxidative.stress = 246.2 / AF
Threshold3_oxidative.stress = 1268.9 / AF
Threshold4_oxidative.stress = 4796.8 / AF
```

```{r Theme, include=FALSE}
#Theme type
     theme.type <- theme_bw(base_size = 15) +
                   #    dark_theme_bw(base_size = 18) +
  theme(plot.title = element_text(hjust = 0.5),
                    plot.subtitle = element_text(hjust = 0.5))
     #color selection
     fill.type <-    scale_fill_viridis(discrete = TRUE)#,
                         #scale_fill_brewer(palette = "Paired"),
                         # scale_fill_tron(),
                         # scale_fill_locuszoom(),
                         # scale_fill_d3(),
                         # scale_fill_npg(),
                         # scale_fill_jama())
     #color selection
     color.type <- scale_color_viridis(discrete = TRUE)#,
                         # scale_color_brewer(palette = "Paired"),
                         # scale_color_tron(),
                         # scale_color_locuszoom(),
                         # scale_color_d3(),
                         # scale_color_npg(),
                         # scale_color_jama())

```



```{r}
# print table
kable(data.frame(
  Category = c("Hazard Concentrations (particles/L)"),
  "Threshold1" = Threshold1,
  "Threshold 2" = Threshold2,
  "Threshold 3" = Threshold3,
  "Threshold 4" = Threshold4))
```

```{r}
#print table of sizes
kable(data.frame(
  Category = c("Concentration Alignment Parameters"),
  "Marine Alpha" = alpha.marine,
  "Freshwater Alpha" = alpha.freshwater,
  "lower_size_range_microns" = x1D_set,
  "upper_size_range_microns" = x2D_set))
```
To compare thresholds to concentrations observed in the environment, datasets compiled in previous meta-analyses were collated (Covernton et al. 2019; Adam, Yang, and Nowack 2019).

Adam, Véronique, Tong Yang, and Bernd Nowack. 2019. “Toward an Ecotoxicological Risk Assessment of Microplastics: Comparison of Available Hazard and Exposure Data in Freshwaters.” Environmental Toxicology and Chemistry 38 (2): 436–47. https://doi.org/10.1002/etc.4323.

Covernton, Garth A., Christopher M. Pearce, Helen J. Gurney-Smith, Stephen G. Chastain, Peter S. Ross, John F. Dower, and Sarah E. Dudas. 2019. “Size and Shape Matter: A Preliminary Analysis of Microplastic Sampling Technique in Seawater Studies with Implications for Ecological Risk Assessment.” Science of The Total Environment 667 (June): 124–32. https://doi.org/10.1016/j.scitotenv.2019.02.346.

Koutnik, Vera S., Jamie Leonard, Sarah Alkidim, Francesca J. DePrima, Sujith Ravi, Eric M.V. Hoek, and Sanjay K. Mohanty. 2021. “Distribution of Microplastics in Soil and Freshwater Environments: Global Analysis and Framework for Transport Modeling.” Environmental Pollution 274 (April): 116552. https://doi.org/10/gnqffq.

Zhu, Xia, Keenan Munno, Jelena Grbic, Larissa Meghan Werbowski, Jacqueline Bikker, Annissa Ho, Edie Guo, et al. 2021. “Holistic Assessment of Microplastics and Other Anthropogenic Microdebris in an Urban Bay Sheds Light on Their Sources and Fate.” ACS ES&T Water, May, acsestwater.0c00292. https://doi.org/10.1021/acsestwater.0c00292.




```{r}
#data import
#read in tox data
aoc_z <- readRDS(file = "Tox Data/aoc_z.Rda")

# Adam et al (2019) data needs correcting
adam <- read.csv("Concentration Data/Datasets/adam2019.csv", na.strings = "N.A.") %>% 
  rename(Sampling.apparatus = ï..Sampling.apparatus) %>% 
  mutate(x1M = Min.particle.size.um,
         x2M = Max.particle.size.um) %>% 
  mutate(Sample.Type = "sample")

#SF bay data from Zhu et al (2021)
sfBay <- read.csv("Concentration Data/Datasets/SFBayData.csv", na.strings = "NA", stringsAsFactors = TRUE) %>%
  rename(sampleID = ï..sampleID,
          x1M = Min.particle.size.um,
         x2M = Max.particle.size.um) %>% 
  mutate(Sample.Type = "sample")
# import from Covernton et al (2019)
covernton <- read.csv("Concentration Data/Datasets/Covernton.csv", na.strings = "NA", stringsAsFactors = TRUE) %>%
  rename(x1M = Min.particle.size.um,
         x2M = Max.particle.size.um) %>% 
  mutate(Sample.Type = "sample",
         source = doi)
 
###### # import data from Koutnik et al (2021) ###### https://www.sciencedirect.com/science/article/abs/pii/S0269749121001305?via%3Dihub 
### NOTE: Koutnik et al (2021) did report upper size limits for monitoring data, so 5,000 um is assumed. The sensitivity of this assumption should be tested. Data from https://doi.org/10.6084/m9.figshare.13114175.v3 
koutnik <- read.csv("Concentration Data/Datasets/koutnik_simple.csv", na.strings = c("NA", "#N/A"), stringsAsFactors = TRUE, strip.white = TRUE) %>% 
  rename(source = ï..source,
       #  study = Reference,
         x1M = Min.particle.size.um) %>% 
        # x2M = Max.particle.size.um) %>% #max particle size iisn't available, so assume 5000 um
  mutate(x2M = 5000) %>% 
  mutate(freshwater_saltwater = case_when(
    System == "River" ~ "Freshwater",
    System == "Lake" ~ "Freshwater",
    System == "Estuary" ~ "Saltwater",
    System == "Wetland" ~ "Freshwater",
    System == "Glacier & Snow" ~ "Freshwater",
    System == "Urban Canal" ~ "Freshwater",
    grepl("soil", System, ignore.case = TRUE) ~ "Soil")) %>% 
  mutate(Sample.Type = "Sample") %>% 
  mutate(study = Reference)

#note that some data here may be duplicatively reported with Covernton et al (2019). Covernton did not report study DOI's, so we'll need a way to compare by author name using approximate matches.
library(fuzzyjoin)
#overlap <- stringdist_left_join(
overlap <- left_join(koutnik %>%  dplyr::select(source, study, doi), covernton %>%  dplyr::select(source, study), by = "study") %>%  #drop_na(study.y) %>% 
  distinct()
#it doesn't seem like there's many overlapping sources...
```


## Size-based Correction
Given an upper limit (UL) and lower limit (LL) of the measured and default size range, a dimensionless correction factor ($CF_{meas}$) for measured environmental concentrations may be calculated, which rescales the measured number concentrations for a certain size range to the number concentration for the microplastics default (D) size range (e.g. 1 to 5,000 um) (Koelmans et al 2020). Coefficients for the environmental-specific compartment for the power law distribution for length (L) with slope $\alpha_L$ is from Table S4 of Kooi et al (2021). 

$CF_{Meas} = \frac{L^{1-a}_{UL,D} - L^{1-a}_{LL,D}}{L^{1-a}_{UL,M} - L^{1-a}_{LL,M}}$

```{r}
# Align Data

#function to derive correction factor (CF) from Koelmans et al (equation 2)
CFfnx = function(a = alpha, #default alpha from Koelmans et al (2020)
                 x2D = x2D_set, #set detault values to convert ranges to (1-5,000 um) #5mm is upper defuault 
                 x1D = x1D_set, #1 um is lower default size
                 x2M, x1M){
  
  CF = (x2D^(1-a)-x1D^(1-a))/(x2M^(1-a)-x1M^(1-a))
  
  return(CF)
}
#verify it works (expected answer is 40.37)
#CFfnx(x1M = 333, x2M = 5000)

adam_new <- adam %>% 
  mutate(CF = case_when(
    freshwater_saltwater == "Freshwater" ~ CFfnx(a = alpha.freshwater, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set),
    freshwater_saltwater == "Saltwater" ~ CFfnx(a = alpha.marine, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set))) %>%  #create new column with correction factor 
  mutate(particles.m3.corrected = CF * Single.Measurement.conc....m3.) %>% #convert single concenetrations
  mutate(particles.m3.corrected_mean = CF * Mean.conc....m3.) %>%  #convert mean concentrations from distributions
  mutate(particles.m3.corrected_median = CF * Median.conc....m3.) %>%   #convert mean concentrations from distributions
  mutate(particles.single.median.m3 = ifelse(is.na(particles.m3.corrected), particles.m3.corrected_median, particles.m3.corrected)) %>% 
  mutate(particles.m3.master = ifelse(is.na(particles.single.median.m3), particles.m3.corrected_mean, particles.single.median.m3)) %>% 
  mutate(particle.L.master = particles.m3.master/1000) %>% 
  filter(particle.L.master > 0) %>% 
  mutate(unaligned.particle.L.master = particle.L.master / CF) %>% 
  mutate(System = factor(System)) %>% 
  mutate(source = "Adam")

# correct aquatic concentrations for SF Bay
sfBay_new <- sfBay %>% 
  mutate(CF = case_when(
    System == "Estuary" ~ CFfnx(a = alpha.marine, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set),
   is.na(System) ~ CFfnx(a = alpha.freshwater, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set))) %>%  #create new column with correction factor 
  mutate(particle.L.master = particles.L.blank.corrected * CF) %>% 
  rename(unaligned.particle.L.master = particles.L.blank.corrected) %>% 
  filter(unaligned.particle.L.master > 0) %>%  #remove blanks. should convert to 1/2 LOQ...
  mutate(source = "SFEI") %>% 
  mutate(Reference = "Zhu et. al 2021") %>% 
  rename(Sampling.location = general.location) %>% 
  dplyr::select(-c(particles.kg.blank.corrected,
                   particles.fish.blank.corrected))

# correct aquatic concentrations for Ocean Samples
covernton_new <- covernton %>% 
   mutate(CF = case_when(
    System == "Ocean" ~ CFfnx(a = alpha.marine, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set),
   is.na(System) ~ CFfnx(a = alpha.freshwater, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set))) %>% 
  mutate(particle.L.master = conc....m3. * CF) %>% 
  rename(unaligned.particle.L.master = conc....m3.) %>% 
  mutate(source = "Covernton") %>% 
  rename(Reference = study) %>% 
  rename(Sampling.location = Sampling.Location) %>% 
  select(c(Sampling.apparatus, Sampling.location, x1M, x2M, Sample.Type, System, unaligned.particle.L.master, CF,particle.L.master, source, Reference)) %>% 
   mutate(sampleID = NA,
         specific.location = NA,
         latitude = NA,
         longitude = NA,
         sample.matrix = "water",
         sample.matrix.specific = "surface water"
         )

# Align Koutnik data
koutnik_new <- koutnik %>% 
  #create new column with correction factor 
  mutate(CF = case_when(
    freshwater_saltwater == "Freshwater" ~ CFfnx(a = alpha.freshwater, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set),
    freshwater_saltwater == "Saltwater" ~ CFfnx(a = alpha.marine, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set))) %>%  
  #align data
  mutate(particle.L.master = unaligned.particle.L.master * CF) %>% 
  select(c(Sampling.location, x1M, x2M, Sample.Type, System, unaligned.particle.L.master, CF,particle.L.master, source, Reference, sample.matrix)) %>% 
    mutate(sampleID = NA,
         specific.location = NA,
         latitude = NA,
         longitude = NA,
         sample.matrix.specific = NA,
         Sampling.apparatus = NA
         )

## join datasets ##
#first ensure that both datasets share all columns
adam_sub <- adam_new %>% 
  select(c(Sampling.apparatus, Sampling.location, x1M, x2M, Sample.Type, System, unaligned.particle.L.master, CF, particle.L.master, source, Reference)) %>% 
  mutate(sampleID = NA,
         specific.location = NA,
         latitude = NA,
         longitude = NA,
         sample.matrix = "water",
         sample.matrix.specific = "surface water"
         )

#join data
globalData <- rbind(adam_sub, sfBay_new, covernton_new, koutnik_new) %>% 
  mutate(compartment = case_when(
    System == "Lake" ~ "freshwater",
    System == "River" ~ "freshwater",
    System == "Estuary" ~ "marine",
    System == "Ocean" ~ "marine",
  )) %>% 
  mutate(Conc = particle.L.master) %>% 
  mutate_if(is.character, as.factor)
```

## Global Exceedances
```{r}
#make new dataframe to plot both histograms together
sampleSimpleADAM <- globalData %>%
  filter(sample.matrix.specific == "surface water") %>% 
  filter(System == "Ocean") %>% 
  drop_na(Conc) %>% 
  droplevels()

#make new dataframe to plot both histograms together
dfADAM <- rbind(sampleSimpleADAM)#,food.dilution.simple)

#calculate exceedance
dfADAM_exceedance <- dfADAM %>% 
  mutate(aboveThreshold = factor(case_when(
    Conc < Threshold1 ~ "below Threshold 1",
    Conc >= Threshold1 & Conc < Threshold2 ~ "above Threshold 1",
    Conc >= Threshold2 & Conc < Threshold3 ~ "above Threshold 2",
    Conc >= Threshold3 & Conc < Threshold4 ~ "above Threshold 3",
    Conc >= Threshold4 ~ "above Threshold 4"
  )))

#give summary stat for exceedance
exceedance <- dfADAM_exceedance  %>%
  filter(Sample.Type == "sample") %>% 
  dplyr::select(c(Conc, aboveThreshold)) %>%
  group_by(aboveThreshold) %>%
  dplyr::summarize(n = n()) %>% 
  mutate(rel.freq = paste0(round(100 * n/sum(n), 0), "%"))

kable(exceedance)
```
### Concentrations Histogram
```{r}
binwidth <- 0.25

globalData %>% 
  ggplot(aes(x = particle.L.master,
             fill = source,
            # color = source, 
             binwidth = binwidth)) +
  # geom_histogram(aes(y = ..count.. / (sum(..count..) * binwidth)), 
  #                binwidth = binwidth,
  #                alpha = 0.9,
  #                position = "stack") +
  geom_density( alpha = 0.6, lwd = 0.8, adjust = 0.6) +
  scale_fill_manual(name = "Location", labels = c("Rivers and Lakes",
                                                  "Oceans",
                                                  "San Francisco Bay"
                                                  ),
                    values = cal_palette("superbloom3")) + 
                   #values = c("#00798c", "#d1495b", "black")) +
  scale_x_continuous(name = "Particles/L",breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif, trans = "log10")+
  ylab("Normalized Abundance") +
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  labs(title = "Global Surface Water Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("n = 70 studies, 95 sampling locations, n_samples = 747; corrected for size, blanks. Alpha = ",alpha.marine))+
  dark_theme_minimal(base_size = 25) +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        axis.text =  element_text(size = 16),
        legend.text = element_text(size =14),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14),
    plot.caption = element_text(size = 12))
```
### Concentrations boxplot
```{r}


globalData %>% 
  mutate(source_f = factor(case_when(
    source == "SFEI" ~ "San Francisco Bay",
    source == "Covernton" ~ "Global Oceans",
    source == "Adam" ~ "Global Freshwaters",
  ))) %>% 
  ggplot(aes(x = particle.L.master,
             fill = source_f,
            # color = source, 
            y = source_f)) +
 geom_boxplot(notch = TRUE) +
   scale_fill_manual(name = "Location",
                    values = cal_palette("superbloom3")) + 
                    #values = c("#00798c", "#d1495b")) +
  scale_x_continuous(name = "Particles/L (1-5,000 μm)",
                     breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif, trans = "log10")+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  labs(title = "Global Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um") ) +#,
       #caption = paste("n = 70 studies, 95 sampling locations, n_samples = 747; corrected for size, blanks. Alpha = ",alpha.marine
      
  #theme.type +
  dark_theme_bw() +
  theme(legend.position = "top",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title.y = element_blank(),
        axis.title = element_text(size = 16),
        axis.text =  element_text(size = 16),
        legend.text = element_text(size =14),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```

### Risk Characterization Histogram (Global Marine Data)
```{r}
#generate plot
dfADAM_exceedance %>% 
  filter(Conc > 0) %>% 
  filter(Sample.Type == "sample") %>%
  filter(System %in% c("Ocean", "Estuary")) %>% 
  ggplot(aes(x = Conc, fill = aboveThreshold))+
  geom_histogram(aes(y = ..count../sum(..count..)),bins = 50, alpha = 0.9, position = "identity") +
  #geom_text(aes(x = Threshold1- 0.5*Threshold1, y = 0.045), label = paste(Threshold1,"particles/L"),  color = "goldenrod2") +
  #geom_text(aes(x = Threshold1- 0.5*Threshold1, y = 0.055), label = ("Threshold1"),  color = "goldenrod2") +
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'goldenrod2', size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'tomato1', size = 1.3) +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'mediumvioletred', size = 1.3) +
  geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'gray33', size = 1.3) +
  #geom_text(label = "Threshold 1", color = 'goldenrod2', x = log10(Threshold1) - 0.8*log10(Threshold1), y = 0.055, size = 6)+
#   geom_text(label = "Threshold 2", color = 'tomato1', x = log10(Threshold2) - 0.8*log10(Threshold2), y = 0.055, size = 6)+
 #  geom_text(label = "Threshold 3", color = 'mediumvioletred', x = log10(Threshold3) - 0.8*log10(Threshold3), y = 0.055, size = 6)+
  # geom_text(label = "Threshold 4", color = 'gray33', x = Threshold4 - 0.8*log10(Threshold4), y = 0.055, size = 6)+
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif, trans = "log10")+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  #coord_cartesian(xlim = c(0,100000000)) +
  #scale_x_continuous(labels = scales::scientific) +
   xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "μm)")) +
  scale_y_continuous(name = "Relative Density", labels = scales::percent)+
  scale_fill_manual(values = c("below Threshold 1"= "cyan3", 
                               "above Threshold 1" = "goldenrod2", 
                               "above Threshold 2" = "tomato1",
                               "above Threshold 3" = "violetred4", 
                               "above Threshold 4" = "gray33")) +
  labs(title = "Global Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("Concentration data from n = 70 studies, 95 sampling locations, n_samples = 747; corrected for size, blanks. Alpha = ",alpha.marine))+
  theme.type +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        axis.text =  element_text(size = 16),
        legend.text = element_text(size =14),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```

### SFBay Exceedances
```{r}
#make new dataframe to plot both histograms together
sampleSimpleSFEI <- globalData %>%
  filter(source == "SFEI") %>% 
  filter(sample.matrix.specific == "surface water") %>% 
  drop_na(Conc) %>% 
  droplevels()

#make new dataframe to plot both histograms together
dfSFEI <- rbind(sampleSimpleSFEI)#,food.dilution.simple)

#calculate exceedance
dfSFEI_exceedance <- dfSFEI %>% 
  mutate(aboveThreshold = factor(case_when(
    Conc < Threshold1 ~ "below Threshold 1",
    Conc >= Threshold1 & Conc < Threshold2 ~ "above Threshold 1",
    Conc >= Threshold2 & Conc < Threshold3 ~ "above Threshold 2",
    Conc >= Threshold3 & Conc < Threshold4 ~ "above Threshold 3",
    Conc >= Threshold4 ~ "above Threshold 4"
  )))

#give summary stat for exceedance
exceedance <- dfSFEI_exceedance  %>%
  filter(Sample.Type == "sample") %>% 
  dplyr::select(c(Conc, aboveThreshold)) %>%
  group_by(aboveThreshold) %>%
  dplyr::summarize(n = n()) %>% 
  mutate(rel.freq = paste0(round(100 * n/sum(n), 0), "%"))

exceedance
```
#### Sensitivity Analysis based on Alignments
Table S4 from Kooi et al (2021) includes the mean +- standard deviation for power law exponents. To test the sensitivity of this risk characterization based on alignments, a range of power law exponents for particle length are used within the upper and lower 99% of the data from which the power law exponent was derived. For marine surface water, the alpha value of 2.07 has a standard deviation of 0.03 (Kooi et al 2021). The mean plus or minus one, two, and three standard deviations are used to calculate risk exceedances to test sensitivity.

##### Align
```{r}
alpha.marine.sd <- 0.03
alpha.marine.plus.one <- alpha.marine + alpha.marine.sd
alpha.marine.plus.two <- alpha.marine + (2 * alpha.marine.sd)
alpha.marine.plus.three <- alpha.marine + (3 * alpha.marine.sd)
alpha.marine.minus.one <- alpha.marine - alpha.marine.sd
alpha.marine.minus.two <- alpha.marine - (2 * alpha.marine.sd)
alpha.marine.minus.three <- alpha.marine - (3 * alpha.marine.sd)

#align data for different scenarios
sensitivity <- globalData %>%
  #filter(source == "SFEI") %>% 
  #filter(sample.matrix.specific == "surface water") %>% 
  drop_na(Conc) %>% 
  #derive correction factors
  mutate(plus1SD = CFfnx(a = alpha.marine.plus.one, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set),
         plus2SD = CFfnx(a = alpha.marine.plus.two, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set),
         plus3SD = CFfnx(a = alpha.marine.plus.three, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set),
         minus1SD = CFfnx(a = alpha.marine.minus.one, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set),
         minus2SD = CFfnx(a = alpha.marine.minus.two, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set),
         minus3SD = CFfnx(a = alpha.marine.minus.three, x1M = x1M, x2M = x2M, x1D = x1D_set, x2D = x2D_set)) %>%
  #apply correction fcators
  mutate(conc.plus1 = unaligned.particle.L.master * plus1SD,
         conc.plus2 = unaligned.particle.L.master * plus2SD,
         conc.plus3 = unaligned.particle.L.master * plus3SD,
         conc.minus1 = unaligned.particle.L.master * minus1SD,
         conc.minus2 = unaligned.particle.L.master * minus2SD,
         conc.minus3 = unaligned.particle.L.master * minus3SD)
```

###### PRINT OUT DATA
```{r}
sensitivity
```


##### Compare to thresholds
```{r}
sensitivity.analysis <- sensitivity %>% 
  filter(source == "SFEI") %>% 
  filter(sample.matrix.specific == "surface water") %>% 
  #just select concentrations
  dplyr::select(c(Conc, conc.plus1, conc.plus2, conc.plus3, conc.minus1, conc.minus2, conc.minus3)) %>% 
  #make long data
  pivot_longer(everything()) %>% 
  mutate(aboveThreshold = factor(case_when(
    value < Threshold1_food ~ "below Threshold 1",
    value >= Threshold1_food & value < Threshold2_food ~ "above Threshold 1",
    value >= Threshold2_food & value < Threshold3_food ~ "above Threshold 2",
    value >= Threshold3_food & value < Threshold4_food ~ "above Threshold 3",
    value >= Threshold4_food ~ "above Threshold 4"
  ))) %>% 
  group_by(aboveThreshold, name) %>%
  dplyr::summarize(n = n()) %>% 
  mutate(rel.freq = paste0(round(100 * n/sum(n), 0), "%"))

sensitivity.analysis 
```

##### Plot
```{r}
#ECDF by System
sfBayECDF_sensitivity <- sensitivity %>% 
  filter(source == "SFEI") %>% 
  filter(sample.matrix.specific == "surface water") %>% 
  #just select concentrations
  dplyr::select(c(Conc, conc.plus1, conc.plus2, conc.plus3, conc.minus1, conc.minus2, conc.minus3)) %>% 
  #make long data
  pivot_longer(everything()) %>% 
  mutate(name = as.factor(name)) %>% 
  ggplot() +
 # stat_ecdf(aes(x = value, color = name),
  #          geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = value, color = name),geom = "step", linetype = 'solid', alpha = 0.7, size = 2.5) +
  #color
  scale_color_manual(name = "Alignment Uncertanties",
                     values = c("Conc" = "#e8ffff",
                                "conc.minus1" = "#bfe6ff",
                                "conc.plus1" = "#bfe6ff",
                                "conc.minus2" = "#8cd3ff",
                                "conc.plus2" = "#8cd3ff",
                                "conc.minus3" = "#009dff",
                                "conc.plus3" = "#009dff"),
                     labels = c("Mean", 
                                "68th Percentile",
                                "68th Percentile",
                                "95th Percentile",
                                "95th Percentile",
                                "99.7th Percentile",
                                "99.7th Percentile")) +
  # ##Food Dilution thresholds
  geom_vline(xintercept = Threshold1_food, linetype = 'dashed', color = "#66a182", size = 1.3) +
  geom_vline(xintercept = Threshold4_food, linetype = 'dashed', 
             color = "#d1495b",
             size = 1.3) +
  geom_text(label = "Food Dilution T1", color = "#66a182" , x = Threshold1_food, y = 0.15, size = 6)+
   geom_text(label = "Food Dilution T4", color = "#d1495b", 
            x = Threshold4_food,
            y = 0.25, size = 6)+
  ###Oxidative Stress thresholds
  geom_vline(xintercept = Threshold1_oxidative.stress, linetype = 'dashed',
             color = "#66a182",#"#00798c",
             size = 1.3) +
  geom_vline(xintercept = Threshold4_oxidative.stress, linetype = 'dashed',
             color = "#d1495b",
             size = 1.3) +
  geom_text(label = "Oxidative Stress T1", color = "#66a182",#'#edae49',
            x = Threshold1_oxidative.stress - 0.8 * Threshold1_oxidative.stress, 
            y = 0.45, size = 6) +
  geom_text(label = "Oxidative Stress T4", color = "#d1495b", x =
              Threshold4_oxidative.stress - 0.8 * Threshold4_oxidative.stress, 
            y = 0.55, size = 6)+
    ylab("Cumulative Density") +
  xlab("Particles/L") +
  #xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "um)"))+
  scale_y_continuous(labels = scales::percent)+
  coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  #annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  theme.type +
  theme(legend.title = element_blank(),
        legend.position = "none")
  #labs(title = "Global Surface Water Marine Microplastics Concentrations",
   #    subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
    #   caption = paste("Concentration data from Adams et al (2019): 23 studies, 57 sampling locations, n = 377; corrected for size ranges. Alpha = ",alpha))
 
sfBayECDF_sensitivity
```


### Risk Characterization Histogram (SFBay)
```{r}
#generate plot
dfSFEI_exceedance %>% 
 # filter(Conc > 0) %>% 
  filter(Sample.Type == "sample") %>% 
  ggplot(aes(x = Conc, fill = aboveThreshold))+
  geom_histogram(aes(y = ..count../sum(..count..)),bins = 38, alpha = 0.9, position = "identity") +
  #geom_text(aes(x = Threshold1- 0.5*Threshold1, y = 0.045), label = paste(Threshold1,"particles/L"),  color = "goldenrod2") +
  #geom_text(aes(x = Threshold1- 0.5*Threshold1, y = 0.055), label = ("Threshold1"),  color = "goldenrod2") +
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'goldenrod2', size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'tomato1', size = 1.3) +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'mediumvioletred', size = 1.3) +
  geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'gray33', size = 1.3) +
  #geom_text(label = "Threshold 1", color = 'goldenrod2', x = log10(Threshold1) - 0.8*log10(Threshold1), y = 0.055, size = 6)+
#   geom_text(label = "Threshold 2", color = 'tomato1', x = log10(Threshold2) - 0.8*log10(Threshold2), y = 0.055, size = 6)+
 #  geom_text(label = "Threshold 3", color = 'mediumvioletred', x = log10(Threshold3) - 0.8*log10(Threshold3), y = 0.055, size = 6)+
  # geom_text(label = "Threshold 4", color = 'gray33', x = Threshold4 - 0.8*log10(Threshold4), y = 0.055, size = 6)+
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif, trans = "log10")+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  #coord_cartesian(xlim = c(0,100000000)) +
  #scale_x_continuous(labels = scales::scientific) +
   xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "μm)")) +
  scale_y_continuous(name = "Relative Density", labels = scales::percent)+
  scale_fill_manual(values = c("below Threshold 1"= "cyan3", 
                               "above Threshold 1" = "goldenrod2", 
                               "above Threshold 2" = "tomato1",
                               "above Threshold 3" = "violetred4", 
                               "above Threshold 4" = "gray33")) +
  labs(title = "San Francisco Bay Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("n = 107; corrected for size, blanks. Alpha = ",alpha.marine))+
  theme.type +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        axis.text =  element_text(size = 16),
        legend.text = element_text(size =14),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```
### ECDF (SF Bay)

```{r}
vals <- c("Unaligned" = "white", "Aligned" = "deepskyblue")

#ECDF by System
sfBayECDF <- globalData %>% 
  filter(source == "SFEI") %>% 
  drop_na(particle.L.master) %>% 
  filter(particle.L.master > 0.0) %>% 
    filter(System %in% c("Ocean", "Estuary")) %>% 
  ggplot() +
     #unaligned
  stat_ecdf(aes(x = unaligned.particle.L.master, color = "Unaligned"),
            geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = unaligned.particle.L.master, color = "Unaligned"),geom = "step", linetype = 'solid', alpha = 0.3, size = 1) +
  #aligned
  stat_ecdf(aes(x = particle.L.master, color = "Aligned"),
            geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = particle.L.master, color = "Aligned"),geom = "step", linetype = 'solid', alpha = 0.3, size = 1) +
  #color
  scale_color_manual(name = "alignment",
                     values = vals) +
  # ##Food Dilution thresholds
  geom_vline(xintercept = Threshold1_food, linetype = 'dashed', color = "#66a182", size = 1.3) +
  #geom_vline(xintercept = Threshold2, linetype = 'dashed', color = "#66a182" , size = 1.3) +
  #geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'#edae49', size = 1.3) +
  geom_vline(xintercept = Threshold4_food, linetype = 'dashed', 
             color = "#d1495b",
             size = 1.3) +
  geom_text(label = "Food Dilution T1", color = "#66a182" , x = Threshold1_food, y = 0.15, size = 6)+
 # geom_text(label = "Threshold 2", color = "#66a182" , x = Threshold2, y = 0.22, size = 6)+
  #geom_text(label = "Threshold 3", color = '#edae49', x = Threshold3, y = 0.35, size = 6)+
  geom_text(label = "Food Dilution T4", color = "#d1495b", 
            x = Threshold4_food,
            y = 0.25, size = 6)+
  ###Oxidative Stress thresholds
  geom_vline(xintercept = Threshold1_oxidative.stress, linetype = 'dashed',
             color = "#66a182",#"#00798c",
             size = 1.3) +
  geom_vline(xintercept = Threshold4_oxidative.stress, linetype = 'dashed',
             color = "#d1495b",
             size = 1.3) +
  geom_text(label = "Oxidative Stress T1", color = "#66a182",#'#edae49',
            x = Threshold1_oxidative.stress - 0.8 * Threshold1_oxidative.stress, 
            y = 0.45, size = 6) +
  geom_text(label = "Oxidative Stress T4", color = "#d1495b", x =
              Threshold4_oxidative.stress - 0.8 * Threshold4_oxidative.stress, 
            y = 0.55, size = 6)+
    ylab("Cumulative Density") +
  xlab("Particles/L") +
  #xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "um)"))+
  scale_y_continuous(labels = scales::percent)+
  coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  #annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  theme.type +
  theme(legend.title = element_blank())
  #labs(title = "Global Surface Water Marine Microplastics Concentrations",
   #    subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
    #   caption = paste("Concentration data from Adams et al (2019): 23 studies, 57 sampling locations, n = 377; corrected for size ranges. Alpha = ",alpha))
 
sfBayECDF
```
```{r}
ggsave(plot =sfBayECDF,
       filename = "sfBayECDF.jpeg",
       path = "./Concentration data/Threshold_Manuscript_Figs/", 
       width = 10, height = 6, units = "in",
       bg = "white",
       dpi = 300)
```

###ECDF (SF Bay) MORTALITY
```{r}
vals <- c("Unaligned" = "white", "Aligned" = "deepskyblue")

threshold1_food_mortality = 583
threshold2_food_mortality = 2383
threshold1_oxidative.stress_mortality = 76
threshold2_oxidative.stress_mortality = 1015

#ECDF by System
sfBayECDF_mortality <- globalData %>% 
  filter(source == "SFEI") %>% 
  drop_na(particle.L.master) %>% 
  filter(particle.L.master > 0.0) %>% 
    filter(System %in% c("Ocean", "Estuary")) %>% 
  ggplot() +
     #unaligned
  stat_ecdf(aes(x = unaligned.particle.L.master, color = "Unaligned"),
            geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = unaligned.particle.L.master, color = "Unaligned"),geom = "step", linetype = 'solid', alpha = 0.3, size = 1) +
  #aligned
  stat_ecdf(aes(x = particle.L.master, color = "Aligned"),
            geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = particle.L.master, color = "Aligned"),geom = "step", linetype = 'solid', alpha = 0.3, size = 1) +
  #color
  scale_color_manual(name = "alignment",
                     values = vals) +
  # ##Food Dilution thresholds
  geom_vline(xintercept = threshold1_food_mortality, linetype = 'dashed', color = "red", size = 1.3) +
  #geom_vline(xintercept = Threshold2, linetype = 'dashed', color = "#66a182" , size = 1.3) +
  #geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'#edae49', size = 1.3) +
  geom_vline(xintercept = threshold2_food_mortality, linetype = 'dashed', 
             color = "red",
             size = 1.3) +
  geom_text(label = "Food Dilution T1 (MORTALITY)", color = "red" , x = threshold1_food_mortality, y = 0.15, size =5)+
 # geom_text(label = "Threshold 2", color = "#66a182" , x = Threshold2, y = 0.22, size = 6)+
  #geom_text(label = "Threshold 3", color = '#edae49', x = Threshold3, y = 0.35, size = 6)+
  geom_text(label = "Food Dilution T2 (MORTALITY)", color = "red", 
            x = threshold2_food_mortality,
            y = 0.25, size = 5)+
  ###Oxidative Stress thresholds
  geom_vline(xintercept = threshold1_oxidative.stress_mortality, linetype = 'dashed',
             color = "red",#"#00798c",
             size = 1.3) +
  geom_vline(xintercept = threshold2_oxidative.stress_mortality, linetype = 'dashed',
             color = "red",
             size = 1.3) +
  geom_text(label = "Oxidative Stress T1 (MORTALITY)", color = "red",#'#edae49',
            x = threshold1_oxidative.stress_mortality - 0.8 * threshold1_oxidative.stress_mortality, 
            y = 0.45, size = 5) +
  geom_text(label = "Oxidative Stress T2 (MORTALITY)", color = "red", x =
              threshold2_oxidative.stress_mortality - 0.8 * threshold2_oxidative.stress_mortality, 
            y = 0.55, size = 5)+
    ylab("Cumulative Density") +
  xlab("Particles/L") +
  #xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "um)"))+
  scale_y_continuous(labels = scales::percent)+
  coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  #annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  theme.type +
  theme(legend.title = element_blank())
  #labs(title = "Global Surface Water Marine Microplastics Concentrations",
   #    subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
    #   caption = paste("Concentration data from Adams et al (2019): 23 studies, 57 sampling locations, n = 377; corrected for size ranges. Alpha = ",alpha))
 
sfBayECDF_mortality
```

### ECDF (Global)
```{r}
#ECDF by System
globalData %>% 
  drop_na(particle.L.master) %>% 
  filter(particle.L.master > 0.0) %>% 
filter(System %in% c("Ocean", "Estuary")) %>% 
  ggplot(aes(x = particle.L.master)) + #, color = System))+
  stat_ecdf(geom = "point", size = 1, alpha = 0.5, color = "black") +
  stat_ecdf(geom = "step", linetype = 'solid', alpha = 0.3, size = 1, color = "black") + #'azure3') +
  scale_color_manual(values = wes_palette("Darjeeling1"))+
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = "#00798c", size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = "#66a182" , size = 1.3) +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'#edae49', size = 1.3) +
  geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	"#d1495b", size = 1.3) +
  geom_text(label = "Threshold 1", color = "#00798c" , x = Threshold1, y = 0.15, size = 6)+
  geom_text(label = "Threshold 2", color = "#66a182" , x = Threshold2, y = 0.22, size = 6)+
  geom_text(label = "Threshold 3", color = '#edae49', x = Threshold3, y = 0.35, size = 6)+
  geom_text(label = "Threshold 4", color = "#d1495b", x = Threshold4, y = 0.45, size = 6)+
  ylab("Cumulative Density") +
  xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "um)"))+
  scale_y_continuous(labels = scales::percent)+
  coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  #annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  theme.type #+
  #labs(title = "Global Surface Water Marine Microplastics Concentrations",
   #    subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
    #   caption = paste("Concentration data from Adams et al (2019): 23 studies, 57 sampling locations, n = 377; corrected for size ranges. Alpha = ",alpha))
 
```

### ECDF (SFEI by Matrix)
```{r}
SFEI_ECDF_matrix <- globalData %>% 
  filter(source == "SFEI",
         sample.matrix == "water",
         particle.L.master > 0) %>% 
  drop_na(particle.L.master) %>% 
  ggplot(aes(x = particle.L.master, color = sample.matrix.specific))+
  stat_ecdf(geom = "point", size = 1, alpha = 0.7) +
  stat_ecdf(geom = "step", linetype = 'solid', alpha = 0.5, size = 1.5) +
  scale_color_manual(name = "Matrix",values = wes_palette("Darjeeling1"))+
  # geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'green', size = 1.3) +
  # geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'yellow', size = 1.3) +
  # geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'orange', size = 1.3) +
  # geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'red', size = 1.3) +
  # geom_text(label = "Threshold 1", color = 'green', x = Threshold1, y = 0.15, size = 6)+
  # geom_text(label = "Threshold 2", color = 'yellow', x = Threshold2, y = 0.22, size = 6)+
  # geom_text(label = "Threshold 3", color = 'orange', x = Threshold3, y = 0.35, size = 6)+
  # geom_text(label = "Threshold 4", color = 'red', x = Threshold4, y = 0.45, size = 6)+
  scale_y_continuous(labels = scales::percent)+
  coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  ylab("Cumulative Density") +
  xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, " μm)"))+
  theme.type +
  labs(title = "San Francisco Bay Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "μm"),
       caption = paste("Concentration data from Zhu et al (2021): 29 sampling locations, n = 136; corrected for size ranges. Alpha = ",alpha.marine))+
  theme(
    plot.title = element_text(hjust = 0.5, size = 18),
        plot.subtitle = element_text(hjust = 0.5, size = 14))

SFEI_ECDF_matrix
```

### ECDF (SFEI by Mesh Size)
```{r}
globalData %>% 
  filter(source == "SFEI") %>% 
  filter(sample.matrix == "water") %>% 
  drop_na(particle.L.master) %>% 
  ggplot(aes(x = log10(particle.L.master), color = Sampling.apparatus))+
  stat_ecdf(geom = "point", size = 1, alpha = 0.7) +
  stat_ecdf(geom = "step", linetype = 'solid', alpha = 0.5, size = 1.5) +
  scale_color_manual(name = "Matrix",values = wes_palette("Darjeeling1"))+
  # geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'green', size = 1.3) +
  # geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'yellow', size = 1.3) +
  # geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'orange', size = 1.3) +
  # geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'red', size = 1.3) +
  # geom_text(label = "Threshold 1", color = 'green', x = Threshold1, y = 0.15, size = 6)+
  # geom_text(label = "Threshold 2", color = 'yellow', x = Threshold2, y = 0.22, size = 6)+
  # geom_text(label = "Threshold 3", color = 'orange', x = Threshold3, y = 0.35, size = 6)+
  # geom_text(label = "Threshold 4", color = 'red', x = Threshold4, y = 0.45, size = 6)+
  scale_y_continuous(labels = scales::percent)+
  #coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  ylab("Cumulative Density") +
  xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, " μm)"))+
  theme.type +
  labs(title = "San Francisco Bay Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("Concentration data from Zhu et al (2021): 29 sampling locations, n = 136; corrected for size ranges. Alpha = ",alpha.marine))+
  theme(
    plot.title = element_text(hjust = 0.5, size = 18),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```

### Boxplot SFEI
```{r}
SFEI_mesh_matrix <- globalData %>% 
  filter(source == "SFEI") %>% 
  filter(sample.matrix == "water") %>% 
  drop_na(particle.L.master) %>% 
  ggplot(aes(x = sample.matrix.specific))+
  #aligned
  geom_boxplot(aes(y = particle.L.master),
               alpha = 0.4, notch = TRUE) +
  geom_jitter(aes(y = particle.L.master, color = Sampling.apparatus),
              width = 0.15) +
  #unaligned
 # geom_boxplot(aes(y = unaligned.particle.L.master),
  #             alpha = 0.4, notch = TRUE) +
  geom_jitter(aes(y = unaligned.particle.L.master, color = Sampling.apparatus),
              alpha = 0.3,
              width = 0.15) +

  scale_color_d3(name = "Sampling Apparatus") +
  #scale_color_manual(name = "Sampling Apparatus",values = wes_palette("Darjeeling1"))+
   # geom_hline(yintercept = Threshold1, linetype = 'dashed', color = 'green', size = 1) +
   # geom_hline(yintercept = Threshold2, linetype = 'dashed', color = 'yellow', size = 1) +
   # geom_hline(yintercept = Threshold3, linetype = 'dashed', color = 	'orange', size = 1) +
   # geom_hline(yintercept = Threshold4, linetype = 'dashed', color = 	'red', size = 1) +
  # geom_text(label = "Threshold 1", color = 'green', x = Threshold1, y = 0.15, size = 6)+
  # geom_text(label = "Threshold 2", color = 'yellow', x = Threshold2, y = 0.22, size = 6)+
  # geom_text(label = "Threshold 3", color = 'orange', x = Threshold3, y = 0.35, size = 6)+
  # geom_text(label = "Threshold 4", color = 'red', x = Threshold4, y = 0.45, size = 6)+
  scale_y_log10(breaks = scales::trans_breaks("log10", function(y) 10^y),labels = comma_signif)+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  ylab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, " μm)"))+
  theme.type +
  labs(title = "San Francisco Bay Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
      # caption = paste("Concentration data from Zhu et al (2021): 29 sampling locations, n = 136; corrected for size ranges. Alpha = ",alpha.marine)
      )+
  theme(
    plot.title = element_text(hjust = 0.5, size = 18),
        plot.subtitle = element_text(hjust = 0.5, size = 14),
    axis.title.x = element_blank())

SFEI_mesh_matrix
```

## Modelling

```{r eval=FALSE, include=FALSE}
surfaceData <- globalData %>% 
  filter(sample.matrix.specific == "surface water") %>% 
  dplyr::select(Conc) %>% 
  drop_na(Conc)

sample_dists_ADAM <- ssd_fit_dists(surfaceData, #data frame
                              left = "Conc", #string of the column in data with the concentrations
                              # right = left, #string of the column with the right concentration values. If different from left, then the data are considerd to be censored
                              dists = c("weibull", "llogis", "lnorm", "gamma", "lgumbel"), #char vector of distribution anmes
                              computable = FALSE, #flag specifying whether to only return fits with numerically computable standard errors
                              silent = FALSE) #flag indicating whether fits should fail silently

autoplotADAM<- autoplot(sample_dists_ADAM) #plots the distribution in ggplot2
autoplotADAM
ssd_gof(sample_dists_ADAM) #check the goodness of fit
#there are multiple fitting distributions, so check which fits best
sample_gof_ADAM <- ssd_gof(sample_dists_ADAM)
sample_gof_ADAM[order(sample_gof_ADAM$delta), ] #orders by delta. Use the aicc (Akaike's Information Criterion corrected for sample size) for model selection 
write.csv(sample_gof_ADAM,"Concentration data/sample_gof_ADAM.csv")

#choose the distribution that you want to plot
sample_dists_ADAM_choice <- ssd_fit_dists(samplesADAM, #data frame
                                   left = "Conc", #string of the column in data with the concentrations
                                   # right = left, #string of the column with the right concentration values. If different from left, then the data are considerd to be censored
                                   dists = c("lgumbel"), #char vector of distribution anmes
                                   computable = FALSE, #flag specifying whether to only return fits with numerically computable standard errors
                                   silent = FALSE) #flag indicating whether fits should fail silently
set.seed(99)
sample_pred_ADAM <- predict(sample_dists_ADAM_choice,
                       average = FALSE,
                       ic = "aicc",
                       nboot = 10,
                       ci= TRUE) #estimates model-averaged estimates based on aicc

sample_pred_ADAM # The resultant object is a data frame of the estimated concentration (est) with standard error (se) and lower (lcl) and upper (ucl) 95% confidence limits by percent of species affected (percent). The confidence limits are estimated using parametric bootstrapping.

```

```{r eval=TRUE, include=FALSE}
sample_pred_ADAM %>% mutate_if(is.numeric, ~ signif(., 3)) %>% 
  datatable(rownames = FALSE,
            extensions = c('Buttons', 'Scroller'),
            options = list(
              dom = 'Brftp',
              scrollY = 400,
              scroller = TRUE,
              buttons = c('copy', 'csv', 'excel')), 
            class = "compact",
            colnames = c("Percent", "Estimated Mean Concentration", "Standard Error", "Lower 95% Confidence Limit", "Upper 95% Confidence Limit", "Distribution"),
            caption = "Predicted Concentration distribution with uncertanties."
  )

#order data
samplesADAM <- samplesADAM %>% 
  filter(System != "") #take out blanks

sampleSSDADAM <- samplesADAM[order(samplesADAM$Conc), ]
sampleSSDADAM$frac <- ppoints(samplesADAM$Conc, 0.5)
```


```{r eval=TRUE, include=FALSE}
ECDF_model_occurrence_ADAM <- ggplot(sample_pred_ADAM,aes_string(x = "est")) +
  geom_xribbon(aes_string(xmin = "lcl", xmax = "ucl", y = "percent/100"), alpha = 0.2, color = "#81a88d", fill = "#81a88d") +
  geom_line(aes_string(y = "percent/100"), linetype = 'dashed', alpha = 0.8) +
  geom_point(data = sampleSSDADAM,aes(x = Conc, y =frac, color = System), size =1) + 
  #geom_text(data = sampleSSD, aes(x = Conc, y = frac, label = Location), hjust = 1.1, size = 4) + #season labels
  scale_y_continuous("Cumulative Distribution (%)", labels = scales::percent) +
  #expand_limits(y = c(0, 1)) +
  xlab("Concentration (particles/L)")+
  labs(title = "Adam et al 2019 Microplastics Concentration Cumulative Distribution Function",
       subtitle = "Smoothing/95% CI ribbon based on average of log-logical and log-normal Distributions Fit",
       caption = "Adam et al 2019 data; sampling corrected to 1-5,000 um") +
  coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  scale_color_manual(values = wes_palette("Darjeeling2"))

#white mode
ECDF_model_occurrence_ADAM_white <- ECDF_model_occurrence_ADAM +
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'red') +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 'red') +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 	'red') +
  geom_text(label = "5% HC: 95% LCL", color = 'red', x = Threshold3, y = 0)+
  geom_text(label = "5% hazard concentration", color = 'red', x = 110, y = 0.03)+
  geom_text(label = "5% HC: 95% UCL", color = 'red', x = Threshold2, y = 0)+
  geom_text(x = 110, y = 0, label = paste(Threshold1,"particles/L"), color = 'red') +  #label for hazard conc
  #geom_hline(yintercept = 0.925, linetype = 'twodash', color = "#A2A475") +
  #geom_text(label = "92.5% samples below 5% HC Mean", x = 4.5, y = 0.94, color = "#A2A475") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))
ECDF_model_occurrence_ADAM_white

```

```{r eval=TRUE, include=FALSE}
#dark mode
ECDF_model_occurrence_ADAM_dark <- ECDF_model_occurrence_ADAM +
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'goldenrod2', size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'tomato1', size = 1.3) +
 geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'mediumvioletred', size = 1.3) +
 geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'gray33', size = 1.3) +
  #geom_text(x = Threshold1, y = 0.1, label = paste(Threshold1,"particles/L"), color = 'red', size =5) +  #label for hazard conc
  #geom_hline(yintercept = 0.925, linetype = 'twodash', color = "yellow") +
  #geom_text(label = "92.5%", x = 3.0, y = 0.96, color = "yellow", size = 6) +
  theme.type +
  theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))
ECDF_model_occurrence_ADAM_dark
```

# SFEI Data (uncorrected for blanks, do not use)
```{r eval=TRUE, include=FALSE}
# SFEI data
sfei <- read.csv("Concentration data/Datasets/SFEI.csv", na.strings = "N.A.") %>% 
  #filter(Below_LOD == "N") %>% 
  # align data
  mutate(x1M = 20,
         x2M = 5000) %>% 
  mutate(CF = CFfnx(x1M = x1M, x2M = x2M)) %>%  #create new column with correction factor 
  mutate(particle.L.master = CF * Particles.L_uncorrected)

# read in concentration data
samplessfei <- sfei %>% 
  mutate(Conc = particle.L.master)

#make new dataframe to plot both histograms together
sampleSimplesfei <- samplessfei %>%
  dplyr::select(Conc, Sample.Type) %>% 
  droplevels()

#make new dataframe to plot both histograms together
dfsfei <- rbind(sampleSimplesfei)#,food.dilution.simple)
```


## Exceedances
```{r eval=TRUE, include=FALSE}
#calculate exceedance
dfsfei_exceedance <- dfsfei %>% 
  mutate(aboveThreshold = factor(case_when(
    Conc < Threshold1 ~ "below Threshold 1",
    Conc >= Threshold1 & Conc < Threshold2 ~ "above Threshold 1",
    Conc >= Threshold2 & Conc < Threshold3 ~ "above Threshold 2",
    Conc >= Threshold3 & Conc < Threshold4 ~ "above Threshold 3",
    Conc >= Threshold4 ~ "above Threshold 4"
  )))

#give summary stat for exceedance
exceedance <- dfsfei_exceedance  %>%
  filter(Sample.Type == "sample") %>% 
  dplyr::select(c(Conc, aboveThreshold)) %>%
  group_by(aboveThreshold) %>%
  dplyr::summarize(n = n()) %>% 
  mutate(rel.freq = paste0(round(100 * n/sum(n), 0), "%"))

kable(exceedance)
```
## Histogram
```{r include=FALSE}
#generate plot
dfsfei_exceedance %>% 
  filter(Conc > 0) %>% 
  filter(Sample.Type == "sample") %>% 
  ggplot(aes(x = Conc, fill = aboveThreshold))+
  geom_histogram(aes(y = ..count../sum(..count..)),bins =30, alpha = 0.9, position = "identity") +
  #geom_text(aes(x = Threshold1- 0.5*Threshold1, y = 0.045), label = paste(Threshold1,"particles/L"),  color = "goldenrod2") +
  #geom_text(aes(x = Threshold1- 0.5*Threshold1, y = 0.055), label = ("Threshold1"),  color = "goldenrod2") +
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'goldenrod2', size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'tomato1', size = 1.3) +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'mediumvioletred', size = 1.3) +
  geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'gray33', size = 1.3) +
  #geom_text(label = "Threshold 1", color = 'goldenrod2', x = log10(Threshold1) - 0.8*log10(Threshold1), y = 0.055, size = 6)+
#   geom_text(label = "Threshold 2", color = 'tomato1', x = log10(Threshold2) - 0.8*log10(Threshold2), y = 0.055, size = 6)+
 #  geom_text(label = "Threshold 3", color = 'mediumvioletred', x = log10(Threshold3) - 0.8*log10(Threshold3), y = 0.055, size = 6)+
  # geom_text(label = "Threshold 4", color = 'gray33', x = Threshold4 - 0.8*log10(Threshold4), y = 0.055, size = 6)+
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif, trans = "log10")+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  #coord_cartesian(xlim = c(0,100000000)) +
  #scale_x_continuous(labels = scales::scientific) +
   xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "μm)")) +
  scale_y_continuous(name = "Relative Density", labels = scales::percent)+
  scale_fill_manual(values = c("below Threshold 1"= "cyan3", 
                               "above Threshold 1" = "goldenrod2", 
                               "above Threshold 2" = "tomato1",
                               "above Threshold 3" = "violetred4", 
                               "above Threshold 4" = "gray33")) +
  labs(title = "SF Bay and Sanctuary Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("Concentration data from sfeis et al (2019): 23 studies, 57 sampling locations, n = 377; corrected for size ranges. Alpha = ",alpha.marine))+
  theme.type +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        axis.text =  element_text(size = 16),
        legend.text = element_text(size =14),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```
## ECDF

```{r eval=TRUE, include=FALSE}
#ECDF by System
sfei %>% 
filter(System != "") %>% 
  ggplot(aes(x = particle.L.master)) + #, color = System))+
  stat_ecdf(geom = "point", size = 1, alpha = 0.7) +
  stat_ecdf(geom = "step", linetype = 'solid', alpha = 0.3, size = 1.5, color = 'azure3') +
  scale_color_manual(values = wes_palette("Darjeeling1"))+
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = 'green', size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = 'yellow', size = 1.3) +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'orange', size = 1.3) +
  geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	'red', size = 1.3) +
  geom_text(label = "Threshold 1", color = 'green', x = Threshold1, y = 0.15, size = 6)+
  geom_text(label = "Threshold 2", color = 'yellow', x = Threshold2, y = 0.22, size = 6)+
  geom_text(label = "Threshold 3", color = 'orange', x = Threshold3, y = 0.35, size = 6)+
  geom_text(label = "Threshold 4", color = 'red', x = Threshold4, y = 0.45, size = 6)+
  ylab("Cumulative Density") +
  xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "μm)"))+
  scale_y_continuous(labels = scales::percent)+
  coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  theme.type +
  labs(title = "Global Surface Water Marine Microplastics Concentrations",
       subtitle = paste("Particles/L corrected to:",x1D_set, "to", x2D_set, "um"),
       caption = paste("Concentration data from sfeis et al (2019): 23 studies, 57 sampling locations, n = 377; corrected for size ranges. Alpha = ",alpha.marine))+
  theme(
    plot.title = element_text(hjust = 0.5, size = 18),
        plot.subtitle = element_text(hjust = 0.5, size = 14))
```

# Compare to all tox data
## Prep Data
```{r ERM}
###define sizes for filtering and alignment##
# smaller size bin
small_tier_lower_size <- 1 #um
small_tier_upper_size <- 5000 #um #size to align to
upper.tissue.trans.size.um <- 83 #10 #um #set size for filtering data and x2M
# larger size bin
large_tier_lower_size <- 1 #um
large_tier_upper_size <- 5000 #um

## parametrization ##

# Define params for correction #
alpha.marine = 2.07 #table s4 for marine surface water. length
alpha.freshwater = 2.64 #table s4 for freshwater surface water. length
# define parameters for power law coefficients
a.sa.marine = 1.5 #marine surface area power law
a.sa.freshwater = 2.00 #freshwater surface area power law
a.v.marine = 1.48 #a_V for marine surface water volume
a.v.freshwater = 1.68 #a_V for Freshwater surface water volume
a.m.marine = 1.32 # upper limit fora_m for mass for marine surface water in table S4
a.m.freshwater = 1.65 # upper limit fora_m for mass for freshwater surface water in table S4 
a.ssa.marine = 1.98 # A_S1/SA for marine surface water
a.ssa.freshwater = 2.71 # A_1/SSA for freshwater surface water

#define additional parameters for calculations based on averages in the environment
R.ave.marine = 0.77 #average width to length ratio for microplastics in marine enviornment
p.ave.marine = 1.10 #average density in marine surface water
R.ave.freshwater = 0.67 #average width to length ratio for microplastics in surface freshwater
p.ave.freshwater = 1.04 #average density in freshwater surface water

## First filter data with global filters
aoc_intermediate <- aoc_z %>% 
  filter(!environment %in% c("Terrestrial", "Not Reported"),
         org_f != "Bacterium",
         org_f != "Plant",
         #effect.metric != "HONEC", #need these below
         tier_zero_tech_f == "Red Criteria Passed",
         tier_zero_risk_f == "Red Criteria Passed", #All thresholds must pass technical and risk red criteria
         risk.13 != 0 #Drop studies that received a score of 0 for endpoints criteria (this also drops studies that have not yet been scored) - KEEP THIS AFTER THE RED CRITERIA FILTERS  
         ) %>%  
   #Remove 26C temperature treatment data from Jaimukar et al. 2018
  filter(!(article == 42 & media.temp == 26)) %>% 
  mutate(max.size.ingest.um = 1000 * max.size.ingest.mm) #makes it less confusing below

#join alpha values for each data point
aoc_intermediate_alphas <- aoc_intermediate %>% 
  #assign values to align marine waters
  mutate(alpha.marine = alpha.marine) %>% 
  mutate(a.sa.marine = a.sa.marine) %>% 
   mutate(a.v.marine =  a.v.marine) %>% 
   mutate(a.m.marine =  a.m.marine) %>% 
   mutate(a.ssa.marine = a.ssa.marine) %>% 
   mutate(R.ave.marine = R.ave.marine) %>% 
   mutate(p.ave.marine = p.ave.marine) %>% 
#assign values to align freshwater waters
  mutate(alpha.freshwater = alpha.freshwater) %>% 
  mutate(a.sa.freshwater = a.sa.freshwater) %>% 
   mutate(a.v.freshwater =  a.v.freshwater) %>% 
   mutate(a.m.freshwater =  a.m.freshwater) %>% 
   mutate(a.ssa.freshwater = a.ssa.freshwater) %>% 
   mutate(R.ave.freshwater = R.ave.freshwater) %>% 
   mutate(p.ave.freshwater = p.ave.freshwater)
```

### Alignments
#### Functions
```{r}
###function to derive correction factor (CF) from Koelmans et al (equation 2)
CFfnx = function(a, #default alpha from Koelmans et al (2020)
                 x2D, #set detault values to convert ranges to (1-5,000 μm) #5mm is upper defuault 
                 x1D, #1 um is lower default size
                 x2M, x1M){
  CF = (x2D^(1-a)-x1D^(1-a))/(x2M^(1-a)-x1M^(1-a)) 
  return(CF)}

#### equations for mu_x_poly (note that there are three depending on certain alphas for limits of equation)
#generalizable if a.x =2 or not
mux.polyfnx_generalizable = Vectorize(function(a.x, x_UL, x_LL){
  if(a.x == 1){ # in case a.x = 1
    mux.poly = (x_UL - x_LL)/(log(x_UL/x_LL))
    return(mux.poly)}
  if(a.x == 2){ # in case a.x = 2
     mux.poly = (log10(x_UL/x_LL))/(x_LL^(-1) - x_UL^-1)
     return(mux.poly)}
  else{ #in case alpha is not 2 or 1
    mux.poly = ((1-a.x)/(2-a.x)) * ((x_UL^(2-a.x) - x_LL^(2-a.x))/(x_UL^(1-a.x) - x_LL^(1-a.x)))
    return(mux.poly)}
  },
  vectorize.args = "a.x") # if Vectorize isn't here, the if else won't work
## ^^ Note that the above generalizable function doesn't play well with mutate(case_when), likely due to some bug with dplyr. I don't have a solution to this, so a special equation will need to be used when those values are used...

#in case alpha is not 1 or 2
mux.polyfnx = function(a.x, x_UL, x_LL){
    mux.poly = ((1-a.x)/(2-a.x)) * ((x_UL^(2-a.x) - x_LL^(2-a.x))/(x_UL^(1-a.x) - x_LL^(1-a.x)))
    return(mux.poly)}

##### If alpha does equal 2 #####
mux.polyfnx2 = function(a.x, x_UL,x_LL){
  mux.poly = (log(x_UL/x_LL))/(x_LL^(-1) - x_UL^-1)
  return(mux.poly)}

##### If alpha equals 1 #####
mux.polyfnx1 = function(a.x, x_UL, x_LL){
     mux.poly = (x_UL - x_LL)/(log(x_UL/x_LL)) #natural log
    return(mux.poly)}

### Calculating max ingestible parameters ###
## function to calcualte min and max ingestible surface area ##
SAfnx = function(a, # a = 0.5 * length
                 b, # b = 0.5 * width
                 c # c = 0.5 * height (note that hieght is 0.67 * width)
){
  SA = 4*pi*(((a*b)^1.6 + (a*c)^1.6 + (b*c)^1.6) / 3)^(1/1.6)
  return(SA)}

## max ingestible volume ##

volumefnx = function(R, L){
  volume = 0.111667 * pi * R^2 * L^3 #assumes height = 0.67 * Width, and Width:Length ratio is 'R' (compartment-specific)
  return(volume)}

volumefnx_poly = function(width, length){
  height = width #0.67 * width
  volume = (4/3) * pi * (length/2) * (width/2) * (height/2) #assumes height = 0.67 * Width 
  return(volume)}

#max ingestible mass (only used for mu_mono calculations)
massfnx = function(R, L, p){
  mass = p * #density (g/cm^3)
    0.111667 * pi * R^2 * L^3 * # volume (um^3): assumes height = 0.67 * Width, and Width:Length ratio is 'R' (compartment-specific)
    1/1e12 * 1e6 #correction factor
  return(mass)}

massfnx_poly = function(width, length, p){
  height = width #0.67 * width
  volume = (4/3) * pi * (length/2) * (width/2) * (height/2) #assumes height = 0.67 * Width 
  mass = p * #density (g/cm^3)
    volume * # volume (um^3): assumes height = 0.67 * Width, and Width:Length ratio is 'R' (compartment-specific)
    1/1e12 * 1e6 #correction factor
  return(mass)}

#max ingestible specific surface area
SSAfnx = function(sa, #surface area, calcaulted elsewhere
                  m){ #mass, calculated elsewhere
  SSA = sa/m
    return(SSA)}

#max ingestible specific surface area
SSA.inversefnx = function(sa, #surface area, calcaulted elsewhere
                  m){ #mass, calculated elsewhere
  SSA.inverse = m / sa
    return(SSA.inverse)}
```

#### Calculate

Here we will calculate two aligned exposure concentrations: surface area (1 - 83 μm), and volume (1 - 5,000 μm). For both, the upper aligned value is the smaller of either the nominal size listed or the mouth size of the species.

```{r}
# calculate ERM for each species
aoc_final <- aoc_intermediate_alphas  %>% 
   #### TISSUE TRANSLOCATION ####
# define upper size length for Translocation 
#set to 83um for upper limit or max size ingest, whichever is smaller
mutate(x2M_trans = case_when(is.na(max.size.ingest.um) ~ upper.tissue.trans.size.um, 
                             max.size.ingest.um  < upper.tissue.trans.size.um ~  max.size.ingest.um,
                             max.size.ingest.um  > upper.tissue.trans.size.um ~ upper.tissue.trans.size.um)) %>% 
###### ``````````````````CONSTANTS (not environmnet specific)`````````````` ####
 mutate(EC_mono_p.particles.mL_trans = dose.particles.mL.master) %>% 
  mutate(mu.p.mono = 1) %>% #mu_x_mono is always 1 for particles to particles
   #calculate lower translocatable surface area
  mutate(x_LL_sa_trans = SAfnx(a = 0.5 * x1D_set, #length
                               b = 0.5 * x1D_set, #0.5 * R.ave * x1D_set, #width
                               c = 0.5 * x1D_set  #0.5 * R.ave * 0.67 * x1D_set #height
                               )) %>%  
  #calculate upper translocatable surface area
  mutate(x_UL_sa_trans = SAfnx(a = 0.5 * x2M_trans, 
                               b = 0.5 * x2M_trans, #width #0.5 * R.ave * x2M, 
                               c = 0.5 * x2M_trans #heigth #0.5 * R.ave * 0.67 * x2M
                               )) %>%  
    ##--- laboratory calculations ---###
  ## define mu_x_mono OR mu_x_poly (lab) for alignment to ERM  #
  #(note that if mixed particles were used, a different equation must be used)
  mutate(mu.sa.mono = case_when(
    polydispersity == "monodisperse" ~ particle.surface.area.um2, # use reported surface area in monodisperse
    polydispersity == "polydisperse" ~  mux.polyfnx(a.x = a.sa.marine, # same alignment in main threshold paper 
                                  x_LL = particle.surface.area.um2.min,
                                  x_UL = particle.surface.area.um2.max))) %>% 
  
   # define upper size length for ingestion 
  mutate(x2M_ingest = case_when(is.na(max.size.ingest.um) ~ x2D_set, 
                         max.size.ingest.um < x2D_set ~ max.size.ingest.um,
                         max.size.ingest.um > x2D_set ~ x2D_set
                         )) %>%  #set to 5,000 as upper limit or max size ingest, whichever is smaller
 # calculate effect threshold for particles
  mutate(EC_mono_p.particles.mL_ingest = dose.particles.mL.master) %>% 
  mutate(mu.p.mono = 1) %>% #mu_x_mono is always 1 for particles to particles
   #calculate lower ingestible volume 
  mutate(x_LL_v_ingest = volumefnx_poly(length = x1D_set,
                                 width = x1D_set)) %>% 
  #calculate maximum ingestible volume 
  mutate(x_UL_v_ingest = volumefnx_poly(length = x2M_ingest, # length-limited
                                 #x2D_set, #upper definiton (accouunts for fibers) CONSERVATIVE
                                 width = x2M_ingest)) %>% #ingestion-limited
  
   ##--- laboratory calculations ---###
  ## define mu_x_mono OR mu_x_poly (lab) for alignment to ERM  #
  #(note that if mixed particles were used, a different equation must be used)
  mutate(mu.v.mono = case_when(
    polydispersity == "monodisperse" ~ particle.volume.um3, # use reported volume in monodisperse
    polydispersity == "polydisperse" ~ mux.polyfnx(a.x = a.v.marine, 
                                                   x_LL = particle.volume.um3.min,
                                                   x_UL = particle.volume.um3.max))) %>%
    
  #####------------------------------ Freshwater ---------------------------------####
 # calculate effect threshold for particles
  mutate(mu.p.poly_trans_freshwater = mux.polyfnx(a.x = alpha.freshwater, #alpha for particles
                                 x_UL= x2M_trans, #upper ingestible size limit (width of particle)
                                 x_LL = x1D_set)) %>% 
  # polydisperse effect threshold for particles
  mutate(EC_poly_p.particles.mL_trans_freshwater = (EC_mono_p.particles.mL_trans * mu.p.mono)/mu.p.poly_trans_freshwater) %>% 
   #calculate CF_bio for all conversions
  mutate(CF_bio_trans_freshwater = CFfnx(x1M = x1D_set,#lower size bin
                        x2M = x2M_trans, #upper translocatable
                        x1D = x1D_set, #default
                        x2D = x2D_set,  #default
                        a = alpha.freshwater)) %>%  
  ## Calculate environmentally relevant effect threshold for particles
  mutate(EC_env_p.particles.mL_trans_freshwater = EC_poly_p.particles.mL_trans_freshwater * CF_bio_trans_freshwater) %>%  #aligned particle effect concentraiton (1-5000 um)
  
  #### Surface area ERM ####
##--- environmental calculations ---###
  #calculate mu_x_poly (env) for surface area
  mutate(mu.sa.poly_trans_freshwater = mux.polyfnx(a.sa.freshwater, x_UL_sa_trans, x_LL_sa_trans)) %>% 
   #calculate polydisperse effect concentration for surface area (particles/mL)
  mutate(EC_poly_sa.particles.mL_trans_freshwater = (EC_mono_p.particles.mL_trans * mu.sa.mono)/mu.sa.poly_trans_freshwater) %>%  
  #calculate environmentally realistic effect threshold
  mutate(EC_env_sa.particles.mL_trans_freshwater = EC_poly_sa.particles.mL_trans_freshwater * CF_bio_trans_freshwater) %>% 
  
  ##### FOOD DILUTION ####
 
  mutate(mu.p.poly_ingest_freshwater = mux.polyfnx(a.x = alpha.freshwater, #alpha for particles
                                 x_UL= x2M_ingest, #upper ingestible size limit
                                 x_LL = x1D_set)) %>% 
  # polydisperse effect threshold for particles
  mutate(EC_poly_p.particles.mL_ingest_freshwater = (EC_mono_p.particles.mL_ingest * mu.p.mono)/mu.p.poly_ingest_freshwater) %>% 
   #calculate CF_bio for all conversions
  mutate(CF_bio_ingest_freshwater = CFfnx(x1M = x1D_set,#lower size bin
                        x2M = x2M_ingest, #upper ingestible length
                        x1D = x1D_set, #default
                        x2D = x2D_set,  #default upper size range
                        a = alpha.freshwater)) %>%  
  ## Calculate environmentally relevant effect threshold for particles
  mutate(EC_env_p.particles.mL_ingest_freshwater = EC_poly_p.particles.mL_ingest_freshwater * CF_bio_ingest_freshwater) %>%  #aligned particle effect concentraiton (1-5000 um)
  
  #### volume ERM ####
##--- environmental calculations ---###
   # calculate mu.v.poly
  mutate(mu.v.poly_ingest_freshwater = mux.polyfnx(a.v.freshwater, x_UL_v_ingest, x_LL_v_ingest)) %>% 
  
  #calculate polydisperse effect concentration for volume (particles/mL)
  mutate(EC_poly_v.particles.mL_ingest_freshwater = (EC_mono_p.particles.mL_ingest * mu.v.mono)/mu.v.poly_ingest_freshwater) %>%  
    #calculate environmentally realistic effect threshold
  mutate(EC_env_v.particles.mL_ingest_freshwater = EC_poly_v.particles.mL_ingest_freshwater * CF_bio_ingest_freshwater) %>% 
  
   #####------------------------------ marine ---------------------------------####
 # calculate effect threshold for particles
  mutate(mu.p.poly_trans_marine = mux.polyfnx(a.x = alpha.marine, #alpha for particles
                                 x_UL= x2M_trans, #upper ingestible size limit (width of particle)
                                 x_LL = x1D_set)) %>% 
  # polydisperse effect threshold for particles
  mutate(EC_poly_p.particles.mL_trans_marine = (EC_mono_p.particles.mL_trans * mu.p.mono)/mu.p.poly_trans_marine) %>% 
   #calculate CF_bio for all conversions
  mutate(CF_bio_trans_marine = CFfnx(x1M = x1D_set,#lower size bin
                        x2M = x2M_trans, #upper translocatable
                        x1D = x1D_set, #default
                        x2D = x2D_set,  #default
                        a = alpha.marine)) %>%  
  ## Calculate environmentally relevant effect threshold for particles
  mutate(EC_env_p.particles.mL_trans_marine = EC_poly_p.particles.mL_trans_marine * CF_bio_trans_marine) %>%  #aligned particle effect concentraiton (1-5000 um)
  
  #### Surface area ERM ####
##--- environmental calculations ---###
  #calculate mu_x_poly (env) for surface area
  mutate(mu.sa.poly_trans_marine = mux.polyfnx(a.sa.marine, x_UL_sa_trans, x_LL_sa_trans)) %>% 
   #calculate polydisperse effect concentration for surface area (particles/mL)
  mutate(EC_poly_sa.particles.mL_trans_marine = (EC_mono_p.particles.mL_trans * mu.sa.mono)/mu.sa.poly_trans_marine) %>%  
  #calculate environmentally realistic effect threshold
  mutate(EC_env_sa.particles.mL_trans_marine = EC_poly_sa.particles.mL_trans_marine * CF_bio_trans_marine) %>% 
  
  ##### FOOD DILUTION ####
 
  mutate(mu.p.poly_ingest_marine = mux.polyfnx(a.x = alpha.marine, #alpha for particles
                                 x_UL= x2M_ingest, #upper ingestible size limit
                                 x_LL = x1D_set)) %>% 
  # polydisperse effect threshold for particles
  mutate(EC_poly_p.particles.mL_ingest_marine = (EC_mono_p.particles.mL_ingest * mu.p.mono)/mu.p.poly_ingest_marine) %>% 
   #calculate CF_bio for all conversions
  mutate(CF_bio_ingest_marine = CFfnx(x1M = x1D_set,#lower size bin
                        x2M = x2M_ingest, #upper ingestible length
                        x1D = x1D_set, #default
                        x2D = x2D_set,  #default upper size range
                        a = alpha.marine)) %>%  
  ## Calculate environmentally relevant effect threshold for particles
  mutate(EC_env_p.particles.mL_ingest_marine = EC_poly_p.particles.mL_ingest_marine * CF_bio_ingest_marine) %>%  #aligned particle effect concentraiton (1-5000 um)
  
  #### volume ERM ####
##--- environmental calculations ---###
   # calculate mu.v.poly
  mutate(mu.v.poly_ingest_marine = mux.polyfnx(a.v.marine, x_UL_v_ingest, x_LL_v_ingest)) %>% 
  
  #calculate polydisperse effect concentration for volume (particles/mL)
  mutate(EC_poly_v.particles.mL_ingest_marine = (EC_mono_p.particles.mL_ingest * mu.v.mono)/mu.v.poly_ingest_marine) %>%  
    #calculate environmentally realistic effect threshold
  mutate(EC_env_v.particles.mL_ingest_marine = EC_poly_v.particles.mL_ingest_marine * CF_bio_ingest_marine) %>% 
  
   ###### CLEANUP #####
  mutate(particles.mL.ox.stress_freshwater = EC_env_sa.particles.mL_trans_freshwater,
         particles.mL.food.dilution_freshwater = EC_env_v.particles.mL_ingest_freshwater,
         particles.mL.ox.stress_marine = EC_env_sa.particles.mL_trans_marine,
         particles.mL.food.dilution_marine = EC_env_v.particles.mL_ingest_marine)
```



## Marine
### Plot Aligned Data
Combine tox dataset with occurence data
```{r}
volume <- aoc_final %>% 
  # tier 3/4 filters
  filter(risk.13 != 1,
         bio_f %in% c("Organism", "Population")) %>% 
  filter(Group != "Algae",
         lvl1_f == "Fitness",
         effect.metric == "LOEC"
         ) %>% 
  filter(environment == "Marine") %>% 
         mutate(Conc = particles.mL.food.dilution_marine# / (af.time * af.noec)
                ) %>%  
         drop_na(Conc) %>% 
         mutate(Conc = Conc * 1000) %>% #particles/mL to particles/L
  filter(between(size.length.um.used.for.conversions, 1, 5000))  %>% 
  mutate(tox.occurrence = "tox") %>% 
  dplyr::select(Conc, tox.occurrence)

global <- globalData %>% 
  filter(System %in% c("Ocean", "Estuary")) %>% 
  mutate(tox.occurrence = "occurence") %>% 
  dplyr::select(Conc, tox.occurrence)

tox.occurence <- rbind.data.frame(volume, global)

#build plot
aligned.tox.occurence.plot <- tox.occurence %>% 
  ggplot(aes(x = Conc, fill = tox.occurrence)) +
  #geom_histogram(bins = 40) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(values = cal_palette(name = "superbloom3", type = "discrete"),
                    name = "Tox or Occurence Data", labels = c("Occurence", "NOECs")) +
  scale_x_log10(name = paste("Particles/L (corrected to:",x1D_set, "to", x2D_set, "μm)"),
                             breaks = scales::log_breaks(),
                             labels = comma_signif) +
  ylab("Normalized Abundance") +
 # annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  # labs(title = "Global Surface Water Marine Microplastics Concentrations vs. Tox Data",
  #      subtitle = "Tox data filtered for quality & risk: organism, Population, fitness endpoints",
  #      caption = paste("(26 occurence studies, 37 tox studies, Alpha = ",alpha.marine,")"))+
 dark_theme_minimal(base_size = 25) +
 #theme_bw(base_size = 15) +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        #axis.text =  element_text(size = 16),
        #legend.text = element_text(size =18),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14),
    plot.caption = element_text(hjust = 0.9, size = 14))

aligned.tox.occurence.plot
```
### Plot Un-aligned Data
Combine tox dataset with occurence data
```{r}
unaligned.tox <- aoc_final %>% 
  # tier 3/4 filters
  filter(risk.13 != 1,
         bio_f %in% c("Organism", "Population"),
         Group != "Algae",
         environment == "Marine",
         between(size.length.um.used.for.conversions, 1, 5000),
         lvl1_f == "Fitness",
         effect.metric == "LOEC"
         )  %>%
         mutate(Conc = dose.particles.mL.master #raw NOECs without alignments
                ) %>%  
         drop_na(Conc) %>% 
         mutate(Conc = Conc * 1000) %>% 
  mutate(tox.occurrence = "tox")
 

# revert aligned occurence data to unaligned
unaligned.global <- globalData %>% 
  filter(compartment == "marine") %>% 
  mutate(unaligned = particle.L.master / CF) %>%
  dplyr::select(unaligned) %>% 
  rename(Conc = unaligned) %>% 
  mutate(tox.occurrence = "occurence")


unaligned.tox.occurence <- rbind.data.frame(unaligned.tox %>%  
                                              dplyr::select(Conc, tox.occurrence),
                                            unaligned.global)


####define overlap ###
#bin the data using density
tox.unaligned <- unaligned.tox.occurence %>% 
  filter(tox.occurrence == "tox") %>% 
    dplyr::select(Conc)

occurrence.unaligned <- unaligned.tox.occurence %>% 
  filter(tox.occurrence == "occurence") %>% 
    dplyr::select(Conc)


# 
# ## METHOD 1
# tox.unaligned.density <- density(tox.unaligned$Conc)
# occurrence.unaligned.density <- density(occurrence.unaligned$Conc)
# 
# idx <- (occurrence.unaligned.density$y < tox.unaligned.density$y) &
# (occurrence.unaligned.density$x > min(occurrence.unaligned.density$x)) &
# (occurrence.unaligned.density$x < max(occurrence.unaligned.density$x))
# #overlap
# unaligned_intersection <- min(occurrence.unaligned.density$x[idx])  
# unaligned_intersection
# 
# ##Method 2
# #remotes::install_github("andrewheiss/reconPlots")
# require(reconPlots)
# occurrence.unaligned.df <- data.frame(x = occurrence.unaligned.density$x, 
#                                       y =occurrence.unaligned.density$y)
# 
# tox.unaligned.df <- data.frame(x = tox.unaligned.density$x, 
#                                       y =tox.unaligned.density$y)
# 
# curve_intersect(occurrence.unaligned.df, tox.unaligned.df, empirical = TRUE)
```




```{r}
##### Genereate PLot###
unaligned.tox.occurence.plot <- unaligned.tox.occurence %>% 
  ggplot(aes(x = Conc, fill = tox.occurrence)) +
  #geom_histogram(bins = 40) +
  geom_density(alpha = 0.6) +
  #geom_vline(xintercept = unaligned_intersection, linetype = 'dashed', size = 0.5, color = "black") +
  #annotate(geom = "text", label = round(unaligned_intersection, 2), color = "black", 
   #        x = unaligned_intersection - 1, y = 0.1, size = 4, angle = 90) +
  scale_fill_manual(values = cal_palette(name = "superbloom3", type = "discrete"),
                    name = "Tox or Occurence Data", labels = c("Occurence", "NOECs")) +
  scale_x_log10(name = paste("Particles/L (unaligned)"),
                             breaks = scales::log_breaks(),
                             labels = comma_signif) +
  ylab("Normalized Abundance") +
  # annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  # labs(#title = "Global Surface Water Marine Microplastics Concentrations vs. Tox Data",
  #      #subtitle = "Tox data filtered for quality & risk: organism, Population, fitness endpoints",
  #      caption = paste("(24 occurence studies, 37 tox studies, Alpha = ",alpha,")"))+
  dark_theme_minimal(base_size = 25) +
  #theme_bw(base_size = 15) +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        #axis.text =  element_text(size = 16),
        #legend.text = element_text(size =18),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14),
    plot.caption = element_text(hjust = 0.9, size = 14))

unaligned.tox.occurence.plot
```
#### Manuscript Figure
```{r}
overlap_figures <- ggarrange(unaligned.tox.occurence.plot, aligned.tox.occurence.plot,
                        labels = c("A", "B"), common.legend = TRUE,
                        legend = "bottom",
                        ncol = 2, nrow = 1)

plot(overlap_figures)

ggsave(plot =overlap_figures,
       filename = "overlap_figure_SI-Fig4.jpeg",
       path = "./Concentration data/Threshold_Manuscript_Figs/", 
       width = 10, height = 6, units = "in",
       bg = "white",
       dpi = 300)
```
### ECDF
```{r}
vals <- c("Unaligned" = "black", "Aligned" = "blue")

ECDF_marine <- globalData %>% 
   filter(System %in% c("Ocean", "Estuary")) %>% 
  mutate(unaligned = particle.L.master / CF) %>%
  ggplot(aes(x = unaligned)) + 
  #unaligned
  stat_ecdf(aes(x = unaligned, color = "Unaligned"),
            geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = unaligned, color = "Unaligned"),geom = "step", linetype = 'solid', alpha = 0.3, size = 1) +
  #aligned
  stat_ecdf(aes(x = Conc, color = "Aligned"),
            geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = Conc, color = "Aligned"),geom = "step", linetype = 'solid', alpha = 0.3, size = 1) +
 
  #thresholds
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = "#00798c", size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = "#66a182" , size = 1.3) +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'#edae49', size = 1.3) +
  geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	"#d1495b", size = 1.3) +
  geom_text(label = "1", color = "#00798c" , x = log10(Threshold1) - 0.2, y = 0.1, size = 5)+
  geom_text(label = "2", color = "#66a182" , x = log10(Threshold2) - 0.2, y = 0.1, size = 5)+
  geom_text(label = "3", color = '#edae49', x = log10(Threshold3) + 0.2, y = 0.1, size = 5)+
  geom_text(label = "4", color = "#d1495b", x = log10(Threshold4) + 0.2, y = 0.1, size = 5)+
  #aesthetics
   ylab("Cumulative Density") +
  xlab(paste0("Particles/L"))+
  scale_y_continuous(labels = scales::percent) +
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif) +
   #color scale
  scale_color_manual(name = "alignment",
                     values = vals) +
  #coord_trans(x = "log10") +
  
  #annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  theme.type +
  theme(legend.title = element_blank())

ECDF_marine
```



## Table comparing overlap
```{r}
#require(overlapping)

#can't install package

# #bin the data using density
# tox.unaligned <- unaligned.tox.occurence %>% 
#   filter(tox.occurrence == "tox") %>% 
#     dplyr::select(Conc)
# 
# occurrence.unaligned <- unaligned.tox.occurence %>% 
#   filter(tox.occurrence == "occurence") %>% 
#     dplyr::select(Conc)
# # create list with different distributions
# unaligned <- list(tox = tox.unaligned$Conc, occurrence = occurrence.unaligned$Conc)
# out <- overlap(unaligned, plot = TRUE)
# out$OV #estimate overlapped areas
```

```{r}
require(ggplot2)
require(reshape2)

# Melt and plot
munaligned.tox.occurence <- melt(unaligned.tox.occurence)

ggplot(munaligned.tox.occurence) +
  geom_density(aes(x = log10(value), color = tox.occurrence))

# Find points that intersect  
#intersect(df$x, df$y)
```


# Tox Sizes vs. Monitoring Cut-offs
## Histograms
```{r}
unaligned.tox.2 <- aoc_final %>% 
  # tier 3/4 filters
  #filter(risk.13 != 1,
         #bio_f %in% c("Organism", "Population")) %>% 
         mutate(Conc = dose.particles.mL.master / (af.time * af.noec)) %>%  
         drop_na(Conc) %>% 
         mutate(Conc = Conc * 1000) %>% 
 # filter(between(size.length.um.used.for.conversions, 1, 5000))  %>% 
  mutate(tox.occurrence = "tox") %>% 
  mutate(x1M = size.length.um.used.for.conversions) %>% 
  dplyr::select(x1M, tox.occurrence)

# extract size cutoff from monitoring data
unaligned.global.2 <- dfADAM %>% 
  #mutate(unaligned = particle.L.master / CF) %>%
  dplyr::select(x1M) %>% 
  #rename(Conc = unaligned) %>% 
  mutate(tox.occurrence = "occurence")
  
#join datasets for plotting
sizes.tox.occurence <- rbind.data.frame(unaligned.tox.2, unaligned.global.2)

#### PLOTTING ####
sizes.tox.occurence %>% 
   ggplot(aes(x = x1M, fill = tox.occurrence)) +
  #geom_histogram(bins = 40) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(values = cal_palette(name = "superbloom3", type = "discrete"),
                    name = "Tox or Occurence Data", 
                    labels = c("Lower size limits for microplastics sampling",
                               "Sizes of Microplastics tested in ecotoxicology")) +
  scale_x_log10(name =  bquote("size ("~mu*"m)"),
                             breaks = scales::log_breaks(),
                             labels = comma_signif) +
  ylab("Relative Frequency") +
 # annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  # labs(title = "Microplastics Monitoring Lower Size Limits vs. Sizes of Microplastics Tested in Ecotoxicology Studies"#,
  #      #caption = paste("(24 occurence studies, 37 tox studies, Alpha = ",alpha,")")
  #      ) +
  dark_theme_minimal() +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 16),
        axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
        #axis.text =  element_text(size = 16),
        legend.text = element_text(size =12),
    legend.position = "top",
    legend.justification = "left",
    legend.direction = "vertical",
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14),
    plot.caption = element_text(hjust = 0.9, size = 12))
```

## ECDFs

```{r}

# get lower limit for occurence data for plotting
lower.size <- sizes.tox.occurence %>% 
  filter(tox.occurrence == "occurence") %>% 
  summarize("lower" = min(x1M))

#build ECDF
sizes.tox.occurence %>% 
ggplot(aes(x = x1M, color = tox.occurrence))+
  stat_ecdf(geom = "point", size = 1, alpha = 0.9, pad = FALSE) +
  stat_ecdf(geom = "step", linetype = 'solid', alpha = 0.7, size = 1.5, pad = FALSE) +
  scale_color_manual(values = cal_palette(name = "superbloom3", type = "discrete"),
                    name = "Tox or Occurence Data", 
                    labels = c("Lower size limits for microplastics sampling",
                               "Sizes of Microplastics tested in ecotoxicology")) +
  ylab("Cumulative Frequency") +
  xlab(bquote("size ("~mu*"m)")) +
  # lower size dotted lines
  geom_segment(x = lower.size[[1]], xend = lower.size[[1]], y = 0.13, yend = 0, 
  linetype = 'dashed', color = '#00798c', size = 1) +
  geom_segment(x = 0.001, xend = lower.size[[1]], y = 0.13, yend = 0.13, 
  linetype = 'dashed', color = '#00798c', size = 1) +
  scale_y_continuous(labels = scales::percent) +
  coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  labs(title = "Microplastics Monitoring Lower Size Limits vs. Sizes of Microplastics Tested in Ecotoxicology Studies") +
  dark_theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
        axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
        #axis.text =  element_text(size = 16),
        legend.text = element_text(size =14),
    legend.position = "top",
    legend.justification = "left",
    legend.direction = "vertical",
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14),
    plot.caption = element_text(hjust = 0.9, size = 12))
```

# Are sampling sizes and concentrations related?
The following analysis tests whether the alignments are accurate.
```{r}
oceanData <- globalData %>% 
  filter(System == "Ocean")


globalData %>% 
  filter(System == "Ocean") %>% 
  ggplot(aes(x = x1M, y = Conc, color = Sampling.location)) +
  geom_point() +
  scale_x_log10(name = "Lower Size Limit of Detection") +
  scale_y_log10(name = "1 - 5,000 µm Aligned Concentration (Particles/L)") +
  dark_theme_bw()
  
```
```{r}
locations.thresholds <- globalData %>% 
  filter(System == "Ocean") %>% 
  mutate(Sampling.location = fct_reorder(Sampling.location, Conc, .fun = median)) %>% 
  ggplot(aes(x = Conc, y = Sampling.location#,
             #color = Sampling.location
             )) +
  geom_boxplot() +
  geom_point() +
  geom_vline(xintercept = Threshold1_food, linetype = 'dashed', color = "#00798c", size = 1.3) +
  geom_vline(xintercept = Threshold4_food, linetype = 'dashed', color = "#66a182" , size = 1.3) +
  geom_vline(xintercept = Threshold1_oxidative.stress, linetype = 'dashed', color = 	'#edae49', size = 1.3) +
  geom_vline(xintercept = Threshold4_oxidative.stress, linetype = 'dashed', color = 	"#d1495b", size = 1.3) +
  geom_text(label = "Tier 1 Food Dilution", color = "#00798c" , x = Threshold1_food, y = 14, size = 5)+
  geom_text(label = "Tier 4 Food Dilution", color = "#66a182" , x = Threshold4_food, y = 13.5, size = 5)+
  geom_text(label = "Tier 1 Oxidative Stress", color = '#edae49', x = Threshold1_oxidative.stress, y = 13, size = 5)+
  geom_text(label = "Tier 4 Oxidative Stress", color = "#d1495b", x = Threshold4_oxidative.stress, y = 12.5, size = 5)+
  xlab(paste0("Particles/L (" ,x1D_set, " to ", x2D_set, "μm)"))+
  coord_trans(x = "log10") +
  scale_x_continuous(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif)+
  annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  theme.type +
  dark_theme_bw()

locations.thresholds
```


## FRESHWATER


### Plot Aligned Data
Combine tox dataset with occurence data
```{r}
volume <- aoc_final %>% 
  # tier 3/4 filters
  filter(risk.13 != 1,
         bio_f %in% c("Organism", "Population")) %>% 
  filter(Group != "Algae") %>% 
  filter(environment == "Freshwater") %>% 
         mutate(Conc = particles.mL.food.dilution_freshwater / (af.time * af.noec)) %>%  
         drop_na(Conc) %>% 
         mutate(Conc = Conc * 1000) %>% 
  filter(between(size.length.um.used.for.conversions, 1, 5000))  %>% 
  mutate(tox.occurrence = "tox") %>% 
  dplyr::select(Conc, tox.occurrence)

# occureence data
#make new dataframe to plot both histograms together
freshwater_aligned <- globalData %>%
  filter(sample.matrix.specific == "surface water") %>% 
  filter(System == c("Lake", "River")) %>% 
  drop_na(Conc) %>% 
  droplevels() %>% 
  mutate(tox.occurrence = "occurence") %>% 
  dplyr::select(Conc, tox.occurrence)

freshwater_aligned.tox.occurence <- rbind.data.frame(volume, freshwater_aligned)

#build plot
freshwater.aligned.tox.occurence.plot <- freshwater_aligned.tox.occurence %>% 
  ggplot(aes(x = Conc, fill = tox.occurrence)) +
  #geom_histogram(bins = 40) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(values = cal_palette(name = "superbloom3", type = "discrete"),
                    name = "Tox or Occurence Data", labels = c("Occurence", "NOECs")) +
  scale_x_log10(name = paste("Particles/L (corrected to:",x1D_set, "to", x2D_set, "μm)"),
                             breaks = scales::log_breaks(),
                             labels = comma_signif) +
  ylab("Normalized Abundance") +
 # annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  # labs(#title = "Global Surface Water Freshwater Microplastics Concentrations vs. Tox Data",
  #      #subtitle = "Tox data filtered for quality & risk: organism, Population, fitness endpoints",
  #      caption = paste("(70 occurence studies, 14 tox studies, Alpha = ",alpha,")"))+
  #dark_theme_minimal(base_size = 25) +
 theme_bw(base_size = 15) +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        #axis.text =  element_text(size = 16),
        #legend.text = element_text(size =18),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14),
    plot.caption = element_text(hjust = 0.9, size = 14))

freshwater.aligned.tox.occurence.plot
```
### Plot Un-aligned Data
Combine tox dataset with occurence data
```{r}
unaligned.tox <- aoc_final %>% 
  # tier 3/4 filters
  filter(risk.13 != 1,
         bio_f %in% c("Organism", "Population")) %>% 
         mutate(Conc = dose.particles.mL.master / (af.time * af.noec)) %>%  
         drop_na(Conc) %>% 
         mutate(Conc = Conc * 1000) %>% 
  filter(Group != "Algae") %>% 
  filter(environment == "Freshwater") %>% 
  filter(between(size.length.um.used.for.conversions, 1, 5000))  %>% 
  mutate(tox.occurrence = "tox") %>% 
  dplyr::select(Conc, tox.occurrence)

# revert aligned occurence data to unaligned
unaligned.global <- globalData %>%
  filter(sample.matrix.specific == "surface water") %>% 
  filter(System == c("Lake", "River")) %>% 
  mutate(unaligned = particle.L.master / CF) %>%
  dplyr::select(unaligned) %>% 
  rename(Conc = unaligned) %>% 
  mutate(tox.occurrence = "occurence")



unaligned.tox.occurence <- rbind.data.frame(unaligned.tox, unaligned.global)


####define overlap ###
#bin the data using density
tox.unaligned <- unaligned.tox.occurence %>% 
  filter(tox.occurrence == "tox") %>% 
    dplyr::select(Conc)

occurrence.unaligned <- unaligned.tox.occurence %>% 
  filter(tox.occurrence == "occurence") %>% 
    dplyr::select(Conc)



## METHOD 1
tox.unaligned.density <- density(tox.unaligned$Conc)
occurrence.unaligned.density <- density(occurrence.unaligned$Conc)

idx <- (occurrence.unaligned.density$y < tox.unaligned.density$y) &
(occurrence.unaligned.density$x > min(occurrence.unaligned.density$x)) &
(occurrence.unaligned.density$x < max(occurrence.unaligned.density$x))
#overlap
unaligned_intersection <- min(occurrence.unaligned.density$x[idx])  
unaligned_intersection

##Method 2
#remotes::install_github("andrewheiss/reconPlots")
require(reconPlots)
occurrence.unaligned.df <- data.frame(x = occurrence.unaligned.density$x, 
                                      y =occurrence.unaligned.density$y)

tox.unaligned.df <- data.frame(x = tox.unaligned.density$x, 
                                      y =tox.unaligned.density$y)

#curve_intersect(occurrence.unaligned.df, tox.unaligned.df, empirical = TRUE)
```

```{r}
##### Genereate PLot###
freshwater.unaligned.tox.occurence.plot <- unaligned.tox.occurence %>% 
  ggplot(aes(x = Conc, fill = tox.occurrence)) +
  #geom_histogram(bins = 40) +
  geom_density(alpha = 0.6) +
  #geom_vline(xintercept = unaligned_intersection, linetype = 'dashed', size = 0.5, color = "black") +
  #annotate(geom = "text", label = round(unaligned_intersection, 2), color = "black", 
   #        x = unaligned_intersection - 1, y = 0.1, size = 4, angle = 90) +
  scale_fill_manual(values = cal_palette(name = "superbloom3", type = "discrete"),
                    name = "Tox or Occurence Data", labels = c("Occurence", "NOECs")) +
  scale_x_log10(name = paste("Particles/L (unaligned)"),
                             breaks = scales::log_breaks(),
                             labels = comma_signif) +
  ylab("Normalized Abundance") +
  #annotation_logticks(sides = "b")+ #log scale rick marks on bottom
  # labs(#title = "Global Surface Water Freshwater Microplastics Concentrations vs. Tox Data",
  #      #subtitle = "Tox data filtered for quality & risk: organism, Population, fitness endpoints",
  #      caption = paste("(70 occurence studies, 14 tox studies, Alpha = ",alpha,")"))+
  #dark_theme_minimal(base_size = 25) +
  theme_bw(base_size = 15) +
  theme(#legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 20),
        axis.title = element_text(size = 16),
        #axis.text =  element_text(size = 16),
        #legend.text = element_text(size =18),
        legend.title = element_blank(),
        plot.subtitle = element_text(hjust = 0.5, size = 14),
    plot.caption = element_text(hjust = 0.9, size = 14))

freshwater.unaligned.tox.occurence.plot
```
#### Manuscript Figure
```{r}
overlap_figures_marine_freshwater <- ggarrange(unaligned.tox.occurence.plot, aligned.tox.occurence.plot,
                                               freshwater.unaligned.tox.occurence.plot, freshwater.aligned.tox.occurence.plot,
                        labels = c("A", "B", "C", "D"), common.legend = TRUE,
                        legend = "bottom",
                        ncol = 2, nrow = 2)

plot(overlap_figures_marine_freshwater)

ggsave(plot =overlap_figures_marine_freshwater,
       filename = "overlap_figure_marine_freshwater_SI-Fig5.jpg",
       path = "./Concentration data/Threshold_Manuscript_Figs/", 
       width = 12, height = 8, units = "in",
       dpi = 300)
```
## ECDF
```{r}
vals <- c("Unaligned" = "black", "Aligned" = "blue")

ECDF_freshwater <- globalData %>% 
  filter(sample.matrix.specific == "surface water") %>% 
   filter(System %in% c("Lake", "River")) %>% 
  mutate(unaligned = particle.L.master / CF) %>%
  ggplot() + 
  #unaligned
  stat_ecdf(aes(x = unaligned, color = "Unaligned"),
            geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = unaligned, color = "Unaligned"),geom = "step", linetype = 'solid', alpha = 0.3, size = 1) +
  #aligned
  stat_ecdf(aes(x = Conc, color = "Aligned"),
            geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = Conc, color = "Aligned"),geom = "step", linetype = 'solid', alpha = 0.3, size = 1) +
  #color
  scale_color_manual(name = "alignment",
                     values = vals) +
  #thresholds
  geom_vline(xintercept = Threshold1, linetype = 'dashed', color = "#00798c", size = 1.3) +
  geom_vline(xintercept = Threshold2, linetype = 'dashed', color = "#66a182" , size = 1.3) +
  geom_vline(xintercept = Threshold3, linetype = 'dashed', color = 	'#edae49', size = 1.3) +
  geom_vline(xintercept = Threshold4, linetype = 'dashed', color = 	"#d1495b", size = 1.3) +
  geom_text(label = "1", color = "#00798c" , x = log10(Threshold1) - 0.2, y = 0.1, size = 5)+
  geom_text(label = "2", color = "#66a182" , x = log10(Threshold2) - 0.2, y = 0.1, size = 5)+
  geom_text(label = "3", color = '#edae49', x = log10(Threshold3) + 0.2, y = 0.1, size = 5)+
  geom_text(label = "4", color = "#d1495b", x = log10(Threshold4) + 0.2, y = 0.1, size = 5)+
  #aesthetics
   ylab("Cumulative Density") +
  xlab(paste0("Particles/L"))+
  scale_y_continuous(labels = scales::percent) +
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif) +
  theme.type +
  theme(legend.title = element_blank())

ECDF_freshwater
```

#### Manuscript Figure
```{r}
ECDF_freshwater_marine <- ggarrange(ECDF_marine, ECDF_freshwater,
                        labels = c("A", "B"), common.legend = TRUE,
                        legend = "bottom",
                        ncol = 2, nrow = 1)

plot(ECDF_freshwater_marine)

ggsave(plot =ECDF_freshwater_marine,
       filename = "ECDF_freshwater_marine_SI-Fig6.jpeg",
       path = "./Concentration data/Threshold_Manuscript_Figs/", 
       width = 11, height = 5, units = "in", bg = "white",
       dpi = 300)
```
# FRESHWATER + MARINE

Alvina wants the figure with both freshwater and marine occurence data in the same plot, with translocation and food dilution thresholds annotated in different plots.

## ECDF
### Food Dilution
```{r}
Threshold1_food = 0.2 
Threshold2_food = 2.0
Threshold3_food = 5.4
Threshold4_food = 33.9
```

```{r}
vals <- c("Unaligned" = "black", "Aligned" = "blue")

ECDF_all_food <- globalData %>% 
  filter(sample.matrix.specific == "surface water") %>% 
 #  filter(System %in% c("Lake", "River")) %>% 
  mutate(unaligned = particle.L.master / CF) %>%
  ggplot() + 
  #unaligned
  stat_ecdf(aes(x = unaligned, color = "Unaligned"),
            geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = unaligned, color = "Unaligned"),geom = "step", linetype = 'solid', alpha = 0.3, size = 1) +
  #aligned
  stat_ecdf(aes(x = Conc, color = "Aligned"),
            geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = Conc, color = "Aligned"),geom = "step", linetype = 'solid', alpha = 0.3, size = 1) +
  #color
  scale_color_manual(name = "alignment",
                     values = vals) +
  #thresholds
  geom_vline(xintercept = Threshold1_food, linetype = 'dashed', color = "#00798c", size = 1.3) +
  geom_vline(xintercept = Threshold2_food, linetype = 'dashed', color = "#66a182" , size = 1.3) +
  geom_vline(xintercept = Threshold3_food, linetype = 'dashed', color = 	'#edae49', size = 1.3) +
  geom_vline(xintercept = Threshold4_food, linetype = 'dashed', color = 	"#d1495b", size = 1.3) +
  geom_text(label = "1", color = "#00798c" , x = log10(Threshold1_food) - 0.2, y = 0.1, size = 5)+
  geom_text(label = "2", color = "#66a182" , x = log10(Threshold2_food) - 0.2, y = 0.1, size = 5)+
  geom_text(label = "3", color = '#edae49', x = log10(Threshold3_food) + 0.2, y = 0.1, size = 5)+
  geom_text(label = "4", color = "#d1495b", x = log10(Threshold4_food) + 0.2, y = 0.1, size = 5)+
  #aesthetics
   ylab("Cumulative Density") +
  xlab(paste0("Particles/L"))+
  scale_y_continuous(labels = scales::percent) +
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif) +
  theme.type +
  theme(legend.title = element_blank())

ECDF_all_food
```

### Translocation
```{r}
Threshold1_translocation = 56.6
Threshold2_translocation = 299
Threshold3_translocation = 1385
Threshold4_translocation = 5470
```

```{r}
vals <- c("Unaligned" = "black", "Aligned" = "blue")

ECDF_all_translocation <- globalData %>% 
  filter(sample.matrix.specific == "surface water") %>% 
 #  filter(System %in% c("Lake", "River")) %>% 
  mutate(unaligned = particle.L.master / CF) %>%
  ggplot() + 
  #unaligned
  stat_ecdf(aes(x = unaligned, color = "Unaligned"),
            geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = unaligned, color = "Unaligned"),geom = "step", linetype = 'solid', alpha = 0.3, size = 1) +
  #aligned
  stat_ecdf(aes(x = Conc, color = "Aligned"),
            geom = "point", size = 1, alpha = 0.5) +
  stat_ecdf(aes(x = Conc, color = "Aligned"),geom = "step", linetype = 'solid', alpha = 0.3, size = 1) +
  #color
  scale_color_manual(name = "alignment",
                     values = vals) +
  #thresholds
  geom_vline(xintercept = Threshold1_translocation, linetype = 'dashed', color = "#00798c", size = 1.3) +
  geom_vline(xintercept = Threshold2_translocation, linetype = 'dashed', color = "#66a182" , size = 1.3) +
  geom_vline(xintercept = Threshold3_translocation, linetype = 'dashed', color = 	'#edae49', size = 1.3) +
  geom_vline(xintercept = Threshold4_translocation, linetype = 'dashed', color = 	"#d1495b", size = 1.3) +
  geom_text(label = "1", color = "#00798c" , x = log10(Threshold1_translocation) - 0.2, y = 0.1, size = 5)+
  geom_text(label = "2", color = "#66a182" , x = log10(Threshold2_translocation) - 0.2, y = 0.1, size = 5)+
  geom_text(label = "3", color = '#edae49', x = log10(Threshold3_translocation) + 0.2, y = 0.1, size = 5)+
  geom_text(label = "4", color = "#d1495b", x = log10(Threshold4_translocation) + 0.2, y = 0.1, size = 5)+
  #aesthetics
   ylab("Cumulative Density") +
  xlab(paste0("Particles/L"))+
  scale_y_continuous(labels = scales::percent) +
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif) +
  theme.type +
  theme(legend.title = element_blank())

ECDF_all_translocation
```

#### Manuscript Figure
```{r}
ECDF_all_ERM <- ggarrange(ECDF_all_food, ECDF_all_translocation,
                        labels = c("A", "B"), common.legend = TRUE,
                        legend = "bottom",
                        ncol = 2, nrow = 1)

plot(ECDF_all_ERM)

ggsave(plot =ECDF_all_ERM,
       filename = "ECDF_all_ERM_SI-Fig6.jpeg",
       path = "./Concentration data/Threshold_Manuscript_Figs/", 
       width = 10.5, height = 5, units = "in", bg = "white",
       dpi = 300)
```


# Re-analysis of Koutnick et al (2021) data
```{r}
#ensure colors same between plots
palette1 = scales::hue_pal()(6)
#print(palette1)
names(palette1) <- c("River", "Lake", "Glacier & Snow", "Estuary", "Urban Canal", "Wetland")

#unaligned
unaligned_koutnik <- koutnik_new %>% 
  filter(System != "Stormwater") %>% 
  drop_na(unaligned.particle.L.master) %>% 
  mutate(System = fct_reorder(System, unaligned.particle.L.master, .fun = median)) %>% 
  ggplot(aes(x = unaligned.particle.L.master, y = System, fill = System)) +
  geom_violin(width = 1.4) +
  geom_boxplot(width = 0.1, color = "grey", alpha = 0.8) +
  scale_fill_manual(values = palette1) +
  scale_x_log10(name = "UNALIGNED Microplastics in Freshwater (particles/L)",
                breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif) +
  theme_bw(base_size = 14) +
  theme(legend.position = "none",
        axis.title.y = element_blank())

#aligned
aligned_koutnik <- koutnik_new %>% 
  drop_na(particle.L.master) %>% 
  mutate(System = fct_reorder(System, unaligned.particle.L.master, .fun = median)) %>% 
  ggplot(aes(x = particle.L.master, y = System, fill = System)) +
  geom_violin(width = 1.4) +
  geom_boxplot(width = 0.1, color = "grey", alpha = 0.8) +
  scale_fill_manual(values = palette1) +
  scale_x_log10(name = "ALIGNED Microplastics in Freshwater (particles/L)",
                breaks = scales::trans_breaks("log10", function(x) 10^x),labels = comma_signif) +
  theme_bw(base_size = 14) +
  theme(legend.position = "none",
        axis.title.y = element_blank())

koutnik_side <- ggarrange(unaligned_koutnik, aligned_koutnik,
                        labels = c("A", "B"), common.legend = TRUE,
                        legend = "none",
                        ncol = 2, nrow = 1)

annotate_figure(koutnik_side,
                bottom = text_grob("Re-analysis of doi.org/10.1016/j.envpol.2021.116552 \n using Koelman's alignments. Scott Coffin,Ph.D."))

plot(koutnik_side)

ggsave(plot =koutnik_side,
       filename = "koutnik_side.jpeg",
       path = "./Concentration data/Threshold_Manuscript_Figs/", 
       width = 10, height = 6, units = "in",
       bg = "white",
       dpi = 300)
```

